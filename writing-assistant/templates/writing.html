{% extends "base.html" %}

{% block title %}ÂÜô‰Ωú - {{ project.title }}{% endblock %}

{% block content %}
<div class="writing-container">
    <!-- È°πÁõÆ‰ø°ÊÅØÊ†è -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3>{{ project.title }}</h3>
                <p class="text-muted mb-0">{{ project.subject }} ¬∑ {{ project.article_type }}</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="word-count">
                    <small class="text-muted">Â≠óÊï∞Ôºö</small>
                    <span id="wordCount">{{ project.word_count }}</span>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Êìç‰Ωú
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="saveProject(true)">
                            <i class="fas fa-save"></i> ‰øùÂ≠ò
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="evaluateProject()">
                            <i class="fas fa-check-circle"></i> ÂÆåÊàêËØÑÂàÜ
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.projects') }}">
                            <i class="fas fa-arrow-left"></i> ËøîÂõûÈ°πÁõÆÂàóË°®
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- È¢òÁõÆÊòæÁ§∫ -->
        <div class="topic-display">
            <div class="topic-card">
                <h6 class="topic-label">ÂÜô‰ΩúÈ¢òÁõÆ</h6>
                <p class="topic-text">{{ project.topic }}</p>
            </div>
        </div>
    </div>
    
    <!-- ÂÜô‰ΩúÈò∂ÊÆµÂØºËà™ -->
    <div class="writing-stages">
        <div class="stage-nav">
            <button class="stage-btn active" data-stage="brainstorm">
                <i class="fas fa-lightbulb"></i>
                <span>ÊûÑÊÄù</span>
            </button>
            <button class="stage-btn" data-stage="outline">
                <i class="fas fa-list"></i>
                <span>ÊèêÁ∫≤</span>
            </button>
            <button class="stage-btn" data-stage="writing">
                <i class="fas fa-pen"></i>
                <span>Ê≠£Êñá</span>
            </button>
        </div>
    </div>
    
    <!-- ÂÜô‰ΩúÂÜÖÂÆπÂå∫Âüü -->
    <div class="writing-content">
        <div class="row g-3">
            <div class="col-xl-8 col-lg-7 col-md-8">
                <!-- ÊûÑÊÄùÈò∂ÊÆµ -->
                <div class="stage-content active" id="brainstorm-stage">
                    <div class="stage-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-lightbulb text-warning me-2"></i>ÊûÑÊÄùÈò∂ÊÆµ</h5>
                                <p class="text-muted mb-0">Êï¥ÁêÜÊÄùË∑ØÔºåËÆ∞ÂΩïÁÅµÊÑüÂíåÊÉ≥Ê≥ï</p>
                            </div>
                            <div class="stage-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="getAISuggestions()">
                                    <i class="fas fa-magic"></i> AIÂª∫ËÆÆ
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveProject(true)">
                                    <i class="fas fa-save"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea class="form-control stage-textarea" id="brainstormContent" 
                                  placeholder="üí° Âú®ËøôÈáåËÆ∞ÂΩïÊÇ®ÁöÑÊÉ≥Ê≥ï„ÄÅÁÅµÊÑüÂíåÊûÑÊÄù...&#10;&#10;üéØ ÂÜô‰ΩúÊèêÁ§∫Ôºö&#10;‚Ä¢ Âõ¥ÁªïÈ¢òÁõÆÊ†∏ÂøÉÊÄùËÄÉÂ§ö‰∏™ËßíÂ∫¶&#10;‚Ä¢ Êî∂ÈõÜÁõ∏ÂÖ≥ÁöÑ‰∫ã‰æãÂíåÁ¥†Êùê&#10;‚Ä¢ Á°ÆÂÆöÊñáÁ´†ÁöÑ‰∏ªË¶ÅËßÇÁÇπ&#10;‚Ä¢ ËÄÉËôëËØªËÄÖÁöÑÂÖ¥Ë∂£ÁÇπ&#10;‚Ä¢ ÊÄùËÄÉÊñáÁ´†ÁöÑÂàõÊñ∞‰πãÂ§Ñ">{{ project.brainstorm_content or '' }}</textarea>
                        <div class="textarea-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ÊûÑÊÄùÈò∂ÊÆµÈáçÂú®ÂèëÊï£ÊÄùÁª¥ÔºåËÆ∞ÂΩïÊâÄÊúâÁõ∏ÂÖ≥ÊÉ≥Ê≥ï
                            </small>
                        </div>
                    </div>
                    
                    <!-- ÊûÑÊÄùÈò∂ÊÆµÁöÑÁªüËÆ°ÂíåËØÑÂàÜ -->
                    <div class="stage-bottom-panel mt-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <!-- ÂÜô‰ΩúÁªüËÆ° -->
                                <div class="writing-stats">
                                    <h6><i class="fas fa-chart-bar text-info me-2"></i>ÂÜô‰ΩúÁªüËÆ°</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÂΩìÂâçÂ≠óÊï∞</span>
                                                <span class="stat-value" id="currentWordCount">0</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-target"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÁõÆÊ†áÂ≠óÊï∞</span>
                                                <span class="stat-value">800-1000</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÂÆåÊàêÂ∫¶</span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- ÊûÑÊÄùËØÑÂàÜ -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-star text-warning me-2"></i>ÊûÑÊÄùËØÑÂàÜ</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="brainstorm">
                                                <span class="star" data-value="1">‚òÖ</span>
                                                <span class="star" data-value="2">‚òÖ</span>
                                                <span class="star" data-value="3">‚òÖ</span>
                                                <span class="star" data-value="4">‚òÖ</span>
                                                <span class="star" data-value="5">‚òÖ</span>
                                            </div>
                                            <span class="rating-text" id="brainstormRatingText">Êú™ËØÑÂàÜ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊèêÁ∫≤Èò∂ÊÆµ -->
                <div class="stage-content" id="outline-stage">
                    <div class="stage-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-list text-info me-2"></i>ÊèêÁ∫≤Èò∂ÊÆµ</h5>
                                <p class="text-muted mb-0">Êï¥ÁêÜÁªìÊûÑÔºåÂà∂ÂÆöÂÜô‰ΩúÂ§ßÁ∫≤</p>
                            </div>
                            <div class="stage-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="getAISuggestions()">
                                    <i class="fas fa-magic"></i> AIÂª∫ËÆÆ
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveProject(true)">
                                    <i class="fas fa-save"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea class="form-control stage-textarea" id="outlineContent" 
                                  placeholder="üìù Âú®ËøôÈáåÂà∂ÂÆöÊÇ®ÁöÑÂÜô‰ΩúÂ§ßÁ∫≤...&#10;&#10;üéØ ÊèêÁ∫≤Ë¶ÅÁÇπÔºö&#10;‚Ä¢ Á°ÆÂÆöÊñáÁ´†ÁöÑÂü∫Êú¨ÁªìÊûÑÔºàÊÄªÂàÜÊÄªÁ≠âÔºâ&#10;‚Ä¢ ÂÆâÊéíÂêÑÊÆµËêΩÁöÑ‰∏ªË¶ÅÂÜÖÂÆπ&#10;‚Ä¢ ÁêÜÊ∏ÖÊÆµËêΩÈó¥ÁöÑÈÄªËæëÂÖ≥Á≥ª&#10;‚Ä¢ ËÆæËÆ°Â•ΩÂºÄÂ§¥ÂíåÁªìÂ∞æ&#10;‚Ä¢ Á°Æ‰øùÂÜÖÂÆπÂ±ÇÊ¨°ÂàÜÊòé">{{ project.outline_content or '' }}</textarea>
                        <div class="textarea-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ÊèêÁ∫≤Èò∂ÊÆµÈáçÂú®ÁêÜÊ∏ÖÁªìÊûÑÔºåÁ°Æ‰øùÈÄªËæëÊ∏ÖÊô∞
                            </small>
                        </div>
                    </div>
                    
                    <!-- ÊèêÁ∫≤Èò∂ÊÆµÁöÑÁªüËÆ°ÂíåËØÑÂàÜ -->
                    <div class="stage-bottom-panel mt-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <!-- ÂÜô‰ΩúÁªüËÆ° -->
                                <div class="writing-stats">
                                    <h6><i class="fas fa-chart-bar text-info me-2"></i>ÂÜô‰ΩúÁªüËÆ°</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÂΩìÂâçÂ≠óÊï∞</span>
                                                <span class="stat-value" id="currentWordCount2">0</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-target"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÁõÆÊ†áÂ≠óÊï∞</span>
                                                <span class="stat-value">800-1000</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÂÆåÊàêÂ∫¶</span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar" id="progressBar2" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- ÊèêÁ∫≤ËØÑÂàÜ -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-star text-warning me-2"></i>ÊèêÁ∫≤ËØÑÂàÜ</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="outline">
                                                <span class="star" data-value="1">‚òÖ</span>
                                                <span class="star" data-value="2">‚òÖ</span>
                                                <span class="star" data-value="3">‚òÖ</span>
                                                <span class="star" data-value="4">‚òÖ</span>
                                                <span class="star" data-value="5">‚òÖ</span>
                                            </div>
                                            <span class="rating-text" id="outlineRatingText">Êú™ËØÑÂàÜ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ê≠£ÊñáÈò∂ÊÆµ -->
                <div class="stage-content" id="writing-stage">
                    <div class="stage-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-pen text-success me-2"></i>Ê≠£ÊñáÂÜô‰Ωú</h5>
                                <p class="text-muted mb-0">ÂÆåÊàêÊñáÁ´†Ê≠£ÊñáÔºåË°®ËææÊÇ®ÁöÑËßÇÁÇπ</p>
                            </div>
                            <div class="stage-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="getAISuggestions()">
                                    <i class="fas fa-magic"></i> AIÂª∫ËÆÆ
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveProject(true)">
                                    <i class="fas fa-save"></i> ‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea class="form-control stage-textarea" id="writingContent" 
                                  placeholder="‚úçÔ∏è Âú®ËøôÈáåÂÜô‰ΩúÊÇ®ÁöÑÊñáÁ´†Ê≠£Êñá...&#10;&#10;üéØ ÂÜô‰ΩúË¶ÅÁÇπÔºö&#10;‚Ä¢ Áî®ËØçÂáÜÁ°ÆÁîüÂä®&#10;‚Ä¢ Âè•ÂºèÂØåÊúâÂèòÂåñ&#10;‚Ä¢ ÈÄÇÂΩìËøêÁî®‰øÆËæûÊâãÊ≥ï&#10;‚Ä¢ Ê≥®ÊÑèÊÆµËêΩÈó¥ÁöÑËøáÊ∏°&#10;‚Ä¢ ‰øùÊåÅËØ≠Ë®ÄÈ£éÊ†ºÁªü‰∏Ä">{{ project.writing_content or '' }}</textarea>
                        <div class="textarea-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Ê≠£ÊñáÈò∂ÊÆµÈáçÂú®Ë°®ËææÔºåÊ≥®ÊÑèËØ≠Ë®ÄÁöÑÂáÜÁ°ÆÊÄßÂíåÁîüÂä®ÊÄß
                            </small>
                        </div>
                    </div>
                    
                    <!-- Ê≠£ÊñáÈò∂ÊÆµÁöÑÁªüËÆ°ÂíåËØÑÂàÜ -->
                    <div class="stage-bottom-panel mt-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <!-- ÂÜô‰ΩúÁªüËÆ° -->
                                <div class="writing-stats">
                                    <h6><i class="fas fa-chart-bar text-info me-2"></i>ÂÜô‰ΩúÁªüËÆ°</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÂΩìÂâçÂ≠óÊï∞</span>
                                                <span class="stat-value" id="currentWordCount3">0</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-target"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÁõÆÊ†áÂ≠óÊï∞</span>
                                                <span class="stat-value">800-1000</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ÂÆåÊàêÂ∫¶</span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar" id="progressBar3" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Ê≠£ÊñáËØÑÂàÜ -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-star text-warning me-2"></i>Ê≠£ÊñáËØÑÂàÜ</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="writing">
                                                <span class="star" data-value="1">‚òÖ</span>
                                                <span class="star" data-value="2">‚òÖ</span>
                                                <span class="star" data-value="3">‚òÖ</span>
                                                <span class="star" data-value="4">‚òÖ</span>
                                                <span class="star" data-value="5">‚òÖ</span>
                                            </div>
                                            <span class="rating-text" id="writingRatingText">Êú™ËØÑÂàÜ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <!-- ÁàÜÁÇπËØÑÂàÜ -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-fire text-danger me-2"></i>ÁàÜÁÇπËØÑÂàÜ</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="highlight">
                                                <span class="star" data-value="1">‚òÖ</span>
                                                <span class="star" data-value="2">‚òÖ</span>
                                                <span class="star" data-value="3">‚òÖ</span>
                                                <span class="star" data-value="4">‚òÖ</span>
                                                <span class="star" data-value="5">‚òÖ</span>
                                            </div>
                                            <span class="rating-text" id="highlightRatingText">Êú™ËØÑÂàÜ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊÄª‰ΩìËØÑÂàÜÂíåÊìç‰Ωú -->
                <div class="overall-summary mt-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <!-- ÊÄª‰ΩìËØÑÂàÜ -->
                                    <div class="overall-rating">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6><i class="fas fa-trophy text-warning me-2"></i>ÊÄª‰ΩìËØÑÂàÜ</h6>
                                                <div class="text-muted small">Âπ≥ÂùáÂàÜÊï∞</div>
                                            </div>
                                            <div class="overall-score">
                                                <span class="score-number" id="overallScore">0.0</span>
                                                <span class="score-max">/100</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- ËØÑÂàÜÊìç‰Ωú -->
                                    <div class="rating-actions">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="getAIRating()">
                                            <i class="fas fa-robot me-1"></i> AIÊô∫ËÉΩËØÑÂàÜ
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100" onclick="saveRatings()">
                                            <i class="fas fa-save me-1"></i> ‰øùÂ≠òËØÑÂàÜ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4 col-lg-5 col-md-4">
                <!-- AIÂä©ÊâãÈù¢Êùø -->
                <div class="ai-assistant">
                    <div class="ai-header">
                        <h6><i class="fas fa-robot text-primary"></i> AIÂÜô‰ΩúÂä©Êâã</h6>
                        <small class="text-muted">Êô∫ËÉΩÂàÜÊûê‰∏éÂª∫ËÆÆ</small>
                    </div>
                    
                    <div class="ai-content">
                        <div class="ai-actions mb-3">
                            <button class="btn btn-primary btn-sm w-100 mb-2" onclick="getAIAnalysis()">
                                <i class="fas fa-search me-1"></i> ÂàÜÊûêÂΩìÂâçÂÜÖÂÆπ
                            </button>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="getAISuggestions()">
                                <i class="fas fa-lightbulb me-1"></i> Ëé∑ÂèñÂÜô‰ΩúÂª∫ËÆÆ
                            </button>
                        </div>
                        
                        <div class="ai-feedback" id="aiFeedback">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-robot fa-2x mb-2 text-primary"></i>
                                <p class="mb-0">ÁÇπÂáª‰∏äÊñπÊåâÈíÆËé∑ÂèñAIÂª∫ËÆÆ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Âä†ËΩΩÊ®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Â§ÑÁêÜ‰∏≠...</span>
                </div>
                <p class="mb-0" id="loadingText">AIÊ≠£Âú®ÂàÜÊûêÊÇ®ÁöÑÂÜÖÂÆπ...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
.writing-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

.project-header {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.topic-display {
    margin-top: 15px;
}

.topic-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #007bff;
}

.topic-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.topic-text {
    font-size: 1.1rem;
    margin-bottom: 0;
    color: #333;
}

.writing-stages {
    margin-bottom: 20px;
}

.stage-nav {
    display: flex;
    gap: 10px;
    justify-content: flex-start;
}

.stage-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px 25px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    min-width: 120px;
}

.stage-btn:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.stage-btn.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
}

.stage-btn i {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.writing-content {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stage-content {
    display: none;
}

.stage-content.active {
    display: block;
}

.stage-header {
    margin-bottom: 20px;
}

/* ÊñáÊú¨ËæìÂÖ•Âå∫ÂüüÂÆπÂô® */
.textarea-container {
    position: relative;
    margin-top: 15px;
}

.stage-textarea {
    min-height: 600px;
    max-height: 90vh;
    height: 600px;
    resize: vertical;
    font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px;
    line-height: 1.8;
    padding: 25px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    width: 100%;
}

.stage-textarea:focus {
    border-color: #007bff;
    box-shadow: 0 4px 16px rgba(0,123,255,0.15);
    outline: none;
}

.textarea-footer {
    margin-top: 8px;
    padding: 0 5px;
}

/* Èò∂ÊÆµÂ§¥ÈÉ®Ê†∑Âºè */
.stage-header {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 0;
    border: 1px solid #e9ecef;
}

.stage-actions .btn {
    font-size: 0.875rem;
    padding: 6px 12px;
}

.ai-assistant {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    position: sticky;
    top: 20px;
    height: calc(260vh - 150px);
    display: flex;
    flex-direction: column;
}

.ai-header {
    margin-bottom: 15px;
    text-align: center;
}

.ai-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.ai-feedback {
    flex: 1;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    height: calc(260vh - 300px);
    min-height: 1000px;
}

.writing-stats {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

/* ÂÜô‰ΩúÁªüËÆ°Ê†∑Âºè */
.stats-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.stat-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #007bff;
    color: white;
    border-radius: 8px;
    margin-right: 12px;
    font-size: 1.1rem;
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 2px;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
}

/* ËØÑÂàÜÁ≥ªÁªüÊ†∑Âºè */
.rating-system {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.rating-header {
    margin-bottom: 15px;
}

.rating-header h6 {
    margin-bottom: 5px;
    font-weight: 600;
}

.rating-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #ffc107;
}

.rating-label {
    display: flex;
    align-items: center;
    font-weight: 500;
    margin-bottom: 8px;
}

.rating-stars {
    display: flex;
    align-items: center;
    gap: 10px;
}

.star-rating {
    display: flex;
    gap: 2px;
}

.star {
    font-size: 1.5rem;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s ease;
    user-select: none;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.star.active {
    color: #ff9800;
}

.rating-text {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.overall-rating {
    text-align: center;
}

.overall-score {
    font-size: 1.5rem;
    font-weight: bold;
}

.score-number {
    color: #28a745;
}

.score-max {
    color: #6c757d;
    font-size: 1rem;
}

.rating-actions {
    margin-top: 15px;
}

.rating-actions .btn {
    font-size: 0.9rem;
    padding: 10px 15px;
}

/* ÂèçÈ¶àÂÜÖÂÆπÊ†∑Âºè */
.feedback-section {
    margin-bottom: 20px;
}

.feedback-section h6 {
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #e9ecef;
}

.feedback-section ul {
    margin-bottom: 0;
}

.feedback-section li {
    padding: 5px 0;
    border-bottom: 1px solid #f8f9fa;
}

.feedback-section li:last-child {
    border-bottom: none;
}

/* AIËØÑÂàÜÂèçÈ¶àÊ†∑Âºè */
.ai-scoring-feedback {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #007bff;
}

.ai-scoring-feedback .feedback-section {
    background: white;
    border-radius: 6px;
    padding: 12px;
    border: 1px solid #e9ecef;
}

.ai-scoring-feedback .feedback-content {
    line-height: 1.5;
    white-space: pre-wrap;
}

.ai-scoring-feedback .badge {
    font-size: 0.75rem;
}

.ai-scoring-feedback h6 {
    color: #007bff;
    font-weight: 600;
    margin-bottom: 15px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
}

.stat-label {
    font-weight: 500;
}

.progress {
    width: 100px;
    height: 8px;
}

.word-count {
    font-size: 1.1rem;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
    .writing-container {
        padding: 15px;
    }
    
    .stage-textarea {
        min-height: 600px;
        font-size: 15px;
        padding: 20px;
    }
    
    .ai-assistant {
        position: relative;
        top: auto;
    }
    
    .stage-bottom-panel {
        margin-top: 15px;
    }
}

@media (max-width: 768px) {
    .writing-container {
        padding: 10px;
    }
    
    .stage-nav {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .stage-btn {
        width: 100%;
        max-width: 200px;
        padding: 12px 20px;
    }
    
    .stage-btn i {
        font-size: 1.2rem;
    }
    
    .stage-header {
        padding: 15px;
    }
    
    .stage-header .d-flex {
        flex-direction: column;
        gap: 15px;
    }
    
    .stage-actions {
        display: flex;
        gap: 10px;
        width: 100%;
    }
    
    .stage-actions .btn {
        flex: 1;
        font-size: 0.8rem;
        padding: 8px 12px;
    }
    
    .stage-textarea {
        min-height: 500px;
        font-size: 14px;
        padding: 15px;
    }
    
    .stats-grid {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .stat-item {
        flex: 1;
        min-width: 120px;
        padding: 8px;
    }
    
    .stat-icon {
        width: 30px;
        height: 30px;
        margin-right: 8px;
        font-size: 0.9rem;
    }
    
    .stat-value {
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .project-header {
        padding: 15px;
    }
    
    .project-header .d-flex {
        flex-direction: column;
        gap: 15px;
    }
    
    .stage-textarea {
        min-height: 400px;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .stats-grid {
        flex-direction: column;
    }
    
    .stat-item {
        min-width: auto;
    }
}

/* Èò∂ÊÆµÂ∫ïÈÉ®Èù¢ÊùøÊ†∑Âºè */
.stage-bottom-panel {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #e9ecef;
    margin-top: 20px;
}

.stage-rating {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    height: 100%;
}

.writing-stats {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    height: 100%;
}

.stats-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 1.1rem;
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
}

/* ËØÑÂàÜÊòüÊòüÊ†∑Âºè */
.rating-stars {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.star-rating {
    display: flex;
    gap: 5px;
}

.star {
    font-size: 1.5rem;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.rating-text {
    font-size: 0.9rem;
    color: #6c757d;
    margin-left: 10px;
}

/* ÊÄª‰ΩìÊëòË¶ÅÊ†∑Âºè */
.overall-summary .card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.overall-rating {
    text-align: center;
}

.overall-score {
    font-size: 1.8rem;
    font-weight: bold;
    margin-top: 10px;
}

.score-number {
    color: #28a745;
}

.score-max {
    color: #6c757d;
    font-size: 1.2rem;
}

.rating-actions .btn {
    font-size: 0.9rem;
    padding: 10px 15px;
}

/* Á§∫ËåÉËØ≠Âè•Ê†∑Âºè */
.example-sentences {
    max-height: 300px;
    overflow-y: auto;
}

.example-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.example-item:hover {
    background: #e9ecef;
    border-color: #dee2e6;
}

.example-text {
    font-style: italic;
    color: #495057;
    margin-bottom: 8px;
    line-height: 1.5;
    font-size: 0.95rem;
}

.example-item .btn {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 4px;
}

.example-item .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ÁÆÄÂåñÁöÑUtilsÂØπË±°
window.Utils = {
    showAlert: function(message, type) {
        // Â∞ùËØï‰ΩøÁî®ÂÖ®Â±ÄalertÂÖÉÁ¥†
        const alertElement = document.getElementById('globalAlert');
        if (alertElement) {
            const alertMessage = document.getElementById('alertMessage');
            const alertIcon = document.getElementById('alertIcon');
            if (alertMessage && alertIcon) {
                alertMessage.textContent = message;
                alertIcon.className = 'fas fa-info-circle me-2';
                alertElement.className = 'alert alert-' + (type === 'error' ? 'danger' : type) + ' alert-dismissible fade show';
                alertElement.style.display = 'block';
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
                return;
            }
        }
        // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®ÊµèËßàÂô®alert
        alert(message);
    }
};

const projectId = {{ project.id }};
let currentStage = 'brainstorm';
let autoSaveTimer = null;

// Èò∂ÊÆµÂàáÊç¢
document.querySelectorAll('.stage-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const stage = this.dataset.stage;
        switchStage(stage);
    });
});

function switchStage(stage) {
    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    document.querySelectorAll('.stage-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-stage="${stage}"]`).classList.add('active');
    
    // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫Âüü
    document.querySelectorAll('.stage-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${stage}-stage`).classList.add('active');
    
    currentStage = stage;
    updateWordCount();
}

// Â≠óÊï∞ÁªüËÆ°
function updateWordCount() {
    const textarea = document.getElementById(currentStage + 'Content');
    const content = textarea.value;
    const wordCount = content.replace(/\s/g, '').length;
    
    document.getElementById('currentWordCount').textContent = wordCount;
    document.getElementById('wordCount').textContent = wordCount;
    
    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
    const progress = Math.min((wordCount / 1000) * 100, 100);
    document.getElementById('progressBar').style.width = progress + '%';
}

// ÁªëÂÆöÊñáÊú¨Ê°Ü‰∫ã‰ª∂
document.querySelectorAll('.stage-textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        updateWordCount();
        
        // Ëá™Âä®‰øùÂ≠ò
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveProject, 5000);
    });
});

// ‰øùÂ≠òÈ°πÁõÆ
async function saveProject(showSuccessAlert = false) {
    try {
        const data = {
            brainstorm_content: document.getElementById('brainstormContent').value,
            outline_content: document.getElementById('outlineContent').value,
            writing_content: document.getElementById('writingContent').value,
            status: 'writing'
        };
        
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            if (showSuccessAlert) {
                Utils.showAlert('‰øùÂ≠òÊàêÂäü', 'success');
            } else {
                // ÈùôÈªò‰øùÂ≠òÔºåÂè™Âú®ÊéßÂà∂Âè∞ËÆ∞ÂΩï
                console.log('È°πÁõÆÂ∑≤Ëá™Âä®‰øùÂ≠ò');
            }
        } else {
            Utils.showAlert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + result.message, 'error');
        }
    } catch (error) {
        console.error('‰øùÂ≠òÈîôËØØ:', error);
        if (showSuccessAlert) {
            Utils.showAlert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
        }
    }
}

// AIÂàÜÊûê
async function getAIAnalysis() {
    const textarea = document.getElementById(currentStage + 'Content');
    const content = textarea.value.trim();
    
    if (!content) {
        Utils.showAlert('ËØ∑ÂÖàËæìÂÖ•ÂÜÖÂÆπ', 'warning');
        return;
    }
    
    // Ëé∑ÂèñAIËÆæÁΩÆ
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('ËØ∑ÂÖàÈÖçÁΩÆAIËÆæÁΩÆ', 'warning');
        return;
    }
    
    // ÊûÑÂª∫AIËÆæÁΩÆÂØπË±°
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    showLoading('AIÊ≠£Âú®ÂàÜÊûêÊÇ®ÁöÑÂÜÖÂÆπ...');
    
    try {
        const response = await fetch('/api/ai/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                stage: currentStage,
                content: content,
                ai_provider: parsedSettings.provider,
                ai_model: parsedSettings.model,
                ai_base_url: parsedSettings.base_url,
                ai_api_key: parsedSettings.api_key
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            displayAIFeedback(result.data);
        } else {
            Utils.showAlert('ÂàÜÊûêÂ§±Ë¥•Ôºö' + result.message, 'error');
        }
    } catch (error) {
        console.error('AIÂàÜÊûêÈîôËØØ:', error);
        Utils.showAlert('ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
    } finally {
        hideLoading();
    }
}

// AIÂª∫ËÆÆ
async function getAISuggestions() {
    const textarea = document.getElementById(currentStage + 'Content');
    const content = textarea.value.trim();
    
    // Ëé∑ÂèñAIËÆæÁΩÆ
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('ËØ∑ÂÖàÈÖçÁΩÆAIËÆæÁΩÆ', 'warning');
        return;
    }
    
    // ÊûÑÂª∫AIËÆæÁΩÆÂØπË±°
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    showLoading('AIÊ≠£Âú®ÁîüÊàêÂª∫ËÆÆ...');
    
    try {
        const topicElement = document.querySelector('.topic-text');
        const topic = topicElement ? topicElement.textContent : '';
        
        // Ëé∑ÂèñÈ°πÁõÆ‰ø°ÊÅØ‰ª•Ëé∑ÂèñÂπ¥Á∫ßÂíåÂ≠¶Áßë
        const projectResponse = await fetch(`/api/projects/${projectId}`);
        let grade = 'Âàù‰∏≠';
        let subject = 'ËØ≠Êñá';
        let language = '‰∏≠Êñá';
        
        if (projectResponse.ok) {
            const projectData = await projectResponse.json();
            if (projectData.success && projectData.data) {
                grade = projectData.data.grade || 'Âàù‰∏≠';
                subject = projectData.data.subject || 'ËØ≠Êñá';
                // Ê†πÊçÆÂ≠¶ÁßëÂà§Êñ≠ËØ≠Áßç
                language = subject.includes('Ëã±ËØ≠') ? 'Ëã±ËØ≠' : '‰∏≠Êñá';
            }
        }
        
        // Ëé∑ÂèñÂΩìÂâçÈò∂ÊÆµÁöÑ‰∏≠ÊñáÊèèËø∞
        const stageMap = {
            'brainstorm': 'ÊûÑÊÄù',
            'outline': 'ÊèêÁ∫≤',
            'writing': 'Ê≠£Êñá'
        };
        const currentStageText = stageMap[currentStage] || currentStage;
        
        // Ëé∑ÂèñÊâÄÊúâÊñáÊú¨Ê°ÜÁöÑÂÆåÊï¥ÂÜÖÂÆπ
        const brainstormContent = document.getElementById('brainstormContent').value.trim();
        const outlineContent = document.getElementById('outlineContent').value.trim();
        const writingContent = document.getElementById('writingContent').value.trim();
        
        const response = await fetch('/api/ai/suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                stage: currentStage,
                current_stage_text: currentStageText,
                content: content,
                full_content: {
                    brainstorm: brainstormContent,
                    outline: outlineContent,
                    writing: writingContent
                },
                topic: topic,
                grade: grade,
                subject: subject,
                language: language,
                ai_provider: parsedSettings.provider,
                ai_model: parsedSettings.model,
                ai_base_url: parsedSettings.base_url,
                ai_api_key: parsedSettings.api_key
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('AIÂª∫ËÆÆÂìçÂ∫îÊï∞ÊçÆ:', result.data);
            if (result.data.continuation_sets) {
                console.log('Áª≠ÂÜôÂª∫ËÆÆÊï∞ÊçÆ:', result.data.continuation_sets);
            }
            displayAISuggestions(result.data);
        } else {
            Utils.showAlert('Ëé∑ÂèñÂª∫ËÆÆÂ§±Ë¥•Ôºö' + result.message, 'error');
        }
    } catch (error) {
        console.error('AIÂª∫ËÆÆÈîôËØØ:', error);
        Utils.showAlert('Ëé∑ÂèñÂª∫ËÆÆÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
    } finally {
        hideLoading();
    }
}

// ÊòæÁ§∫AIÂª∫ËÆÆ
function displayAISuggestions(suggestions) {
    const feedbackDiv = document.getElementById('aiFeedback');
    
    let html = '<div class="ai-suggestions">';
    
    // ÂΩìÂâçÁä∂ÊÄÅÁÇπËØÑ
    if (suggestions.current_status_critique) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-info"><i class="fas fa-search"></i> ÂΩìÂâçÁä∂ÊÄÅÁÇπËØÑ</h6>';
        html += `<div class="alert alert-info">${suggestions.current_status_critique}</div>`;
        html += '</div>';
    }
    
    // Èò∂ÊÆµÁâπÂÆöÂª∫ËÆÆ
    if (suggestions.stage_tips && suggestions.stage_tips.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += `<h6 class="text-primary"><i class="fas fa-lightbulb"></i> ${getStageTitle(currentStage)}Âª∫ËÆÆ</h6>`;
        html += '<ul class="list-unstyled">';
        suggestions.stage_tips.forEach(tip => {
            html += `<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>${tip}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Áª≠ÂÜôÂª∫ËÆÆÔºà3Â•óÔºåÊØèÂ•ó2Âè•ËØùÔºâ
    if (suggestions.continuation_sets && suggestions.continuation_sets.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-success"><i class="fas fa-pen-fancy"></i> Áª≠ÂÜôÂª∫ËÆÆ</h6>';
        html += '<div class="continuation-sets">';
        suggestions.continuation_sets.forEach((set, index) => {
            html += `<div class="continuation-set mb-3 p-3 border rounded">`;
            html += `<div class="fw-bold mb-2">Áª≠ÂÜôÊñπÊ°à ${index + 1}Ôºö</div>`;
            if (set.sentences && set.sentences.length >= 2) {
                html += '<div class="continuation-sentences">';
                set.sentences.slice(0, 2).forEach((sentence, sentIndex) => {
                    html += `<div class="sentence-item mb-2">`;
                    html += `<span class="sentence-number badge bg-primary me-2">${sentIndex + 1}</span>`;
                    html += `<span class="sentence-text">${sentence}</span>`;
                    html += '</div>';
                });
                html += '</div>';
                const combinedText = set.sentences.slice(0, 2).join(' ');
                html += `<button class="btn btn-sm btn-outline-success mt-2" onclick="insertContinuation('${combinedText.replace(/'/g, "\\'")}')"`;
                html += `><i class="fas fa-plus me-1"></i>ÊèíÂÖ•ËøôÂ•óÁª≠ÂÜô</button>`;
            }
            html += '</div>';
        });
        html += '</div></div>';
    }
    
    // Á§∫ËåÉËØ≠Âè•
    if (suggestions.example_sentences && suggestions.example_sentences.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-danger"><i class="fas fa-quote-left"></i> Á§∫ËåÉËØ≠Âè•</h6>';
        html += '<div class="example-sentences">';
        suggestions.example_sentences.forEach((sentence, index) => {
            html += `<div class="example-item mb-2">
                <div class="example-text">${sentence}</div>
                <button class="btn btn-sm btn-outline-primary mt-1" onclick="insertExample('${sentence.replace(/'/g, "\\'")}')">
                    <i class="fas fa-plus me-1"></i>ÊèíÂÖ•
                </button>
            </div>`;
        });
        html += '</div></div>';
    }
    
    // ÂÜÖÂÆπÂª∫ËÆÆ
    if (suggestions.content_suggestions && suggestions.content_suggestions.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-success"><i class="fas fa-pen"></i> ÂÜÖÂÆπÂª∫ËÆÆ</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.content_suggestions.forEach(suggestion => {
            html += `<li class="mb-2"><i class="fas fa-plus text-success me-2"></i>${suggestion}</li>`;
        });
        html += '</ul></div>';
    }
    
    // ÂÜô‰ΩúÊäÄÂ∑ß
    if (suggestions.writing_tips && suggestions.writing_tips.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-info"><i class="fas fa-magic"></i> ÂÜô‰ΩúÊäÄÂ∑ß</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.writing_tips.forEach(tip => {
            html += `<li class="mb-2"><i class="fas fa-star text-info me-2"></i>${tip}</li>`;
        });
        html += '</ul></div>';
    }
    
    // ÂèÇËÄÉÁ¥†Êùê
    if (suggestions.references && suggestions.references.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-secondary"><i class="fas fa-book"></i> ÂèÇËÄÉÁ¥†Êùê</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.references.forEach(ref => {
            html += `<li class="mb-2"><i class="fas fa-bookmark text-secondary me-2"></i>${ref}</li>`;
        });
        html += '</ul></div>';
    }
    
    // ‰∏ã‰∏ÄÊ≠•Âª∫ËÆÆ
    if (suggestions.next_steps && suggestions.next_steps.length > 0) {
        html += '<div class="feedback-section">';
        html += '<h6 class="text-warning"><i class="fas fa-arrow-right"></i> ‰∏ã‰∏ÄÊ≠•</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.next_steps.forEach(step => {
            html += `<li class="mb-2"><i class="fas fa-chevron-right text-warning me-2"></i>${step}</li>`;
        });
        html += '</ul></div>';
    }
    
    html += '</div>';
    
    feedbackDiv.innerHTML = html;
}

// ÊèíÂÖ•Á§∫ËåÉËØ≠Âè•Âà∞ÂΩìÂâçÊñáÊú¨Ê°Ü
function insertExample(sentence) {
    const textarea = document.getElementById(currentStage + 'Content');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    // Âú®ÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•Á§∫ËåÉËØ≠Âè•
    const newText = textBefore + sentence + textAfter;
    textarea.value = newText;
    
    // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆÂà∞ÊèíÂÖ•ÊñáÊú¨ÁöÑÊú´Â∞æ
    const newCursorPos = cursorPos + sentence.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    
    // ËÅöÁÑ¶Âà∞ÊñáÊú¨Ê°Ü
    textarea.focus();
    
    // Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°
    updateWordCountForStage(currentStage);
    
    // ÊòæÁ§∫ÁÆÄÁü≠ÊèêÁ§∫
    Utils.showAlert('Â∑≤ÊèíÂÖ•Á§∫ËåÉËØ≠Âè•', 'info', 2000);
    
    // Ëá™Âä®‰øùÂ≠òÔºàÈùôÈªòÔºâ
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => saveProject(false), 2000);
}

// Ëé∑ÂèñÈò∂ÊÆµÊ†áÈ¢ò
function getStageTitle(stage) {
    switch(stage) {
        case 'brainstorm': return 'ÊûÑÊÄù';
        case 'outline': return 'ÊèêÁ∫≤';
        case 'writing': return 'Ê≠£Êñá';
        default: return 'ÂÜô‰Ωú';
    }
}

// ÊòæÁ§∫AIÂèçÈ¶à
function displayAIFeedback(feedback) {
    const feedbackDiv = document.getElementById('aiFeedback');
    
    let html = '<div class="ai-analysis">';
    
    if (feedback.strengths && feedback.strengths.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-success"><i class="fas fa-thumbs-up"></i> ‰ºòÁÇπ</h6>';
        html += '<ul class="list-unstyled">';
        feedback.strengths.forEach(strength => {
            html += `<li class="mb-1"><i class="fas fa-check text-success me-2"></i>${strength}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (feedback.issues && feedback.issues.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> ÈúÄË¶ÅÊîπËøõ</h6>';
        html += '<ul class="list-unstyled">';
        feedback.issues.forEach(issue => {
            html += `<li class="mb-1"><i class="fas fa-minus text-warning me-2"></i>${issue}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (feedback.suggestions && feedback.suggestions.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-primary"><i class="fas fa-lightbulb"></i> Âª∫ËÆÆ</h6>';
        html += '<ul class="list-unstyled">';
        feedback.suggestions.forEach(suggestion => {
            html += `<li class="mb-1"><i class="fas fa-arrow-right text-primary me-2"></i>${suggestion}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (feedback.analysis) {
        html += '<div class="feedback-section">';
        html += '<h6><i class="fas fa-comment"></i> ÂàÜÊûê</h6>';
        html += `<p class="mb-0">${feedback.analysis}</p>`;
        html += '</div>';
    }
    
    html += '</div>';
    
    feedbackDiv.innerHTML = html;
}

// ÂÆåÊàêËØÑÂàÜ
async function evaluateProject() {
    const writingContent = document.getElementById('writingContent').value.trim();
    
    if (!writingContent) {
        Utils.showAlert('ËØ∑ÂÖàÂÆåÊàêÊ≠£ÊñáÂÜô‰Ωú', 'warning');
        return;
    }
    
    // Ëé∑ÂèñAIËÆæÁΩÆ
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('ËØ∑ÂÖàÈÖçÁΩÆAIËÆæÁΩÆ', 'warning');
        return;
    }
    
    // ÊûÑÂª∫AIËÆæÁΩÆÂØπË±°
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    if (confirm('Á°ÆÂÆöË¶ÅÂÆåÊàêÂÜô‰ΩúÂπ∂ËøõË°åËØÑÂàÜÂêóÔºü')) {
        showLoading('AIÊ≠£Âú®ËØÑÂàÜ‰∏≠...');
        
        try {
            const response = await fetch('/api/ai/evaluate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project_id: projectId,
                    ai_provider: parsedSettings.provider,
                    ai_model: parsedSettings.model,
                    ai_base_url: parsedSettings.base_url,
                    ai_api_key: parsedSettings.api_key
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                Utils.showAlert('ËØÑÂàÜÂÆåÊàêÔºÅ', 'success');
                setTimeout(() => {
                    window.location.href = `/review/${projectId}`;
                }, 1500);
            } else {
                Utils.showAlert('ËØÑÂàÜÂ§±Ë¥•Ôºö' + result.message, 'error');
            }
        } catch (error) {
            Utils.showAlert('ËØÑÂàÜÂ§±Ë¥•Ôºö' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
}

// ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

// ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) {
        modal.hide();
    }
}

// ËØÑÂàÜÁ≥ªÁªüÁõ∏ÂÖ≥ÂäüËÉΩ
let stageRatings = {
    brainstorm: 0,
    outline: 0,
    writing: 0,
    highlight: 0
};

// ÂàùÂßãÂåñËØÑÂàÜÁ≥ªÁªü
function initRatingSystem() {
    // ‰∏∫ÊØè‰∏™ÊòüÊòüÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
    document.querySelectorAll('.star-rating').forEach(ratingContainer => {
        const stage = ratingContainer.dataset.stage;
        const stars = ratingContainer.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
            star.addEventListener('click', function() {
                const rating = index + 1;
                setStageRating(stage, rating);
            });
            
            star.addEventListener('mouseenter', function() {
                highlightStars(ratingContainer, index + 1);
            });
        });
        
        ratingContainer.addEventListener('mouseleave', function() {
            const currentRating = stageRatings[stage];
            highlightStars(ratingContainer, currentRating);
        });
    });
    
    // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑËØÑÂàÜ
    loadSavedRatings();
}

// ËÆæÁΩÆÈò∂ÊÆµËØÑÂàÜ
function setStageRating(stage, rating) {
    console.log(`[DEBUG] setStageRating called: stage=${stage}, rating=${rating}`);
    
    // Á°Æ‰øùËØÑÂàÜÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖÔºà0-5Ôºâ
    rating = Math.max(0, Math.min(5, Math.round(rating)));
    stageRatings[stage] = rating;
    
    console.log(`[DEBUG] Updated stageRatings:`, stageRatings);
    
    const ratingContainer = document.querySelector(`.star-rating[data-stage="${stage}"]`);
    console.log(`[DEBUG] Found rating container for ${stage}:`, ratingContainer);
    
    if (ratingContainer) {
        highlightStars(ratingContainer, rating);
    }
    
    // Êõ¥Êñ∞ËØÑÂàÜÊñáÊú¨
    const ratingText = document.getElementById(`${stage}RatingText`);
    if (ratingText) {
        const ratingLabels = ['ÂæàÂ∑Æ', 'ÂæàÂ∑Æ', 'ËæÉÂ∑Æ', '‰∏ÄËà¨', 'ËâØÂ•Ω', '‰ºòÁßÄ'];
        // 0ÂàÜ‰πüÊòØÂ∑≤ËØÑÂàÜÁä∂ÊÄÅÔºåÊòæÁ§∫‰∏∫"ÂæàÂ∑Æ"
        ratingText.textContent = ratingLabels[rating] || 'ÂæàÂ∑Æ';
        console.log(`[DEBUG] Updated rating text for ${stage}: ${ratingText.textContent}`);
    }
    
    // Êõ¥Êñ∞ÊÄª‰ΩìËØÑÂàÜ
    updateOverallRating();
    
    // ‰∏çÂú®ËøôÈáåËá™Âä®‰øùÂ≠òÔºåÈÅøÂÖçÈ¢ëÁπÅË∞ÉÁî®
    // saveRatings();
}

// È´ò‰∫ÆÊòüÊòü
function highlightStars(container, count) {
    console.log(`[DEBUG] highlightStars called: count=${count}`);
    
    const stars = container.querySelectorAll('.star');
    console.log(`[DEBUG] Found ${stars.length} stars in container`);
    
    stars.forEach((star, index) => {
        if (index < count) {
            star.classList.add('active');
            console.log(`[DEBUG] Added 'active' class to star ${index + 1}`);
        } else {
            star.classList.remove('active');
            console.log(`[DEBUG] Removed 'active' class from star ${index + 1}`);
        }
    });
    
    // È™åËØÅÊúÄÁªàÁä∂ÊÄÅ
    const activeStars = container.querySelectorAll('.star.active');
    console.log(`[DEBUG] Final active stars count: ${activeStars.length}`);
    
    // Ê£ÄÊü•ÊØè‰∏™ÊòüÊòüÁöÑÊ†∑Âºè
    stars.forEach((star, index) => {
        const hasActive = star.classList.contains('active');
        const computedStyle = window.getComputedStyle(star);
        console.log(`[DEBUG] Star ${index + 1}: hasActive=${hasActive}, color=${computedStyle.color}`);
    });
}

// Êõ¥Êñ∞ÊÄª‰ΩìËØÑÂàÜ
function updateOverallRating() {
    console.log('[DEBUG] updateOverallRating called');
    console.log('[DEBUG] Current stageRatings:', stageRatings);
    
    // Êñ∞ÁöÑÊùÉÈáçÈÖçÁΩÆÔºöÊûÑÊÄù10%ÔºåÊèêÁ∫≤0%ÔºåÊ≠£Êñá60%ÔºåÁàÜÁÇπ30%
    const weights = {
        brainstorm: 0.10,  // ÊûÑÊÄù 10%
        outline: 0.00,     // ÊèêÁ∫≤ 0%
        writing: 0.60,     // Ê≠£Êñá 60%
        highlight: 0.30    // ÁàÜÁÇπ 30%
    };
    
    let totalWeightedScore = 0;
    let totalWeight = 0;
    
    // ËÆ°ÁÆóÂä†ÊùÉÊÄªÂàÜ
    Object.keys(stageRatings).forEach(stage => {
        const rating = stageRatings[stage];
        const weight = weights[stage] || 0;
        
        if (rating !== undefined && rating !== null) {
            // Â∞Ü5ÊòüËØÑÂàÜËΩ¨Êç¢‰∏∫100ÂàÜÂà∂ÔºåÁÑ∂Âêé‰πò‰ª•ÊùÉÈáç
            const stageScore = (rating / 5) * 100;
            totalWeightedScore += stageScore * weight;
            totalWeight += weight;
            console.log(`[DEBUG] ${stage}: ${rating}Êòü -> ${stageScore}ÂàÜ √ó ${weight} = ${stageScore * weight}`);
        }
    });
    
    console.log('[DEBUG] Total weighted score:', totalWeightedScore);
    console.log('[DEBUG] Total weight:', totalWeight);
    
    // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïËØÑÂàÜÔºåÊòæÁ§∫0ÂàÜ
    if (totalWeight === 0) {
        console.log('[DEBUG] No valid ratings, setting score to 0');
        document.getElementById('overallScore').textContent = '0';
        return;
    }
    
    // ËÆ°ÁÆóÊúÄÁªàÂàÜÊï∞ÔºàÂ∑≤ÁªèÊòØÂä†ÊùÉÂπ≥ÂùáÔºâ
    const finalScore = Math.max(0, Math.min(100, Math.floor(totalWeightedScore)));
    console.log('[DEBUG] Final calculated score:', finalScore);
    
    document.getElementById('overallScore').textContent = finalScore;
    console.log('[DEBUG] Updated overall score display to:', finalScore);
}

// AIÊô∫ËÉΩËØÑÂàÜ
async function getAIRating() {
    const brainstormContent = document.getElementById('brainstormContent').value.trim();
    const outlineContent = document.getElementById('outlineContent').value.trim();
    const writingContent = document.getElementById('writingContent').value.trim();
    
    // Ëé∑ÂèñAIËÆæÁΩÆ
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('ËØ∑ÂÖàÈÖçÁΩÆAIËÆæÁΩÆ', 'warning');
        return;
    }
    
    // ÊûÑÂª∫AIËÆæÁΩÆÂØπË±°
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    showLoading('AIÊ≠£Âú®Êô∫ËÉΩËØÑÂàÜ...');
    
    console.log('=== ÂºÄÂßãAIËØÑÂàÜ ===');
    console.log('ÊûÑÊÄùÂÜÖÂÆπÈïøÂ∫¶:', brainstormContent.length);
    console.log('ÊèêÁ∫≤ÂÜÖÂÆπÈïøÂ∫¶:', outlineContent.length);
    console.log('Ê≠£ÊñáÂÜÖÂÆπÈïøÂ∫¶:', writingContent.length);
    
    try {
        // ‰ΩøÁî®Êñ∞ÁöÑËØÑÂàÜAPI
        const response = await fetch('/api/ai/score_article', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                article_data: {
                    brainstorm: brainstormContent,
                    outline: outlineContent,
                    writing: writingContent,
                    highlight: brainstormContent + '\n' + outlineContent + '\n' + writingContent  // ÁàÜÁÇπÂü∫‰∫éÂÖ®ÊñáÂÜÖÂÆπËØÑ‰º∞
                },
                ai_provider: parsedSettings.provider,
                ai_model: parsedSettings.model,
                ai_api_key: parsedSettings.api_key,
                ai_base_url: parsedSettings.base_url
            })
        });
        
        console.log('AIËØÑÂàÜÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('AIËØÑÂàÜÁªìÊûú:', result);
        
        if (result.success && result.data && result.data.scores) {
            const scores = result.data.scores;
            const stageReasons = result.data.stage_reasons || {};
            console.log('AIËøîÂõûÁöÑÂàÜÊï∞:', scores);
            console.log('AIËøîÂõûÁöÑËØÑ‰ª∑:', stageReasons);
            
            // Â∞Ü100ÂàÜÂà∂ËΩ¨Êç¢‰∏∫0-5ÊòüÁ∫ßËØÑÂàÜ
            if (scores.brainstorm !== undefined) {
                const brainstormRating = Math.max(0, Math.min(5, Math.round((scores.brainstorm / 100) * 5)));
                console.log('ÊûÑÊÄùÂÜÖÂÆπÊúâÂÜÖÂÆπÔºåAIËØÑÂàÜ:', brainstormRating);
                setStageRating('brainstorm', brainstormRating);
            }
            if (scores.outline !== undefined) {
                const outlineRating = Math.max(0, Math.min(5, Math.round((scores.outline / 100) * 5)));
                console.log('ÊèêÁ∫≤ÂÜÖÂÆπÊúâÂÜÖÂÆπÔºåAIËØÑÂàÜ:', outlineRating);
                setStageRating('outline', outlineRating);
            }
            if (scores.writing !== undefined) {
                const writingRating = Math.max(0, Math.min(5, Math.round((scores.writing / 100) * 5)));
                console.log('Ê≠£ÊñáÂÜÖÂÆπÊúâÂÜÖÂÆπÔºåAIËØÑÂàÜ:', writingRating);
                setStageRating('writing', writingRating);
            }
            if (scores.highlight !== undefined) {
                const highlightRating = Math.max(0, Math.min(5, Math.round((scores.highlight / 100) * 5)));
                console.log('ÁàÜÁÇπÂÜÖÂÆπËØÑÂàÜ:', highlightRating);
                setStageRating('highlight', highlightRating);
            }
            
            // ÊòæÁ§∫Ê≠£ÊñáÂíåÁàÜÁÇπÁöÑËØÑ‰ª∑Âú®Âè≥‰æßAIÂª∫ËÆÆÂå∫Âüü
            displayScoringFeedback(scores, stageReasons);
            
            // Ëá™Âä®‰øùÂ≠òËØÑÂàÜ
            await saveRatings();
            Utils.showAlert('AIËØÑÂàÜÂÆåÊàêÂπ∂Â∑≤Ëá™Âä®‰øùÂ≠òÔºÅ', 'success');
        } else {
            // ËØÑÂàÜÂ§±Ë¥•Êó∂ÁªôÂá∫Âü∫Á°ÄËØÑÂàÜÔºåÊ†πÊçÆÂÜÖÂÆπÈïøÂ∫¶ÁªôÂàÜ
            setStageRating('brainstorm', brainstormContent.length > 0 ? 1 : 0);
            setStageRating('outline', outlineContent.length > 0 ? 1 : 0);
            setStageRating('writing', writingContent.length > 0 ? 1 : 0);
            setStageRating('highlight', (brainstormContent + outlineContent + writingContent).length > 0 ? 1 : 0);
            
            // Ëá™Âä®‰øùÂ≠òËØÑÂàÜ
            await saveRatings();
            Utils.showAlert('AIËØÑÂàÜÂ§±Ë¥•ÔºåÂ∑≤ÁªôÂá∫Âü∫Á°ÄËØÑÂàÜÂπ∂‰øùÂ≠ò', 'warning');
        }
    } catch (error) {
        console.error('AIËØÑÂàÜÈîôËØØ:', error);
        
        // Âç≥‰ΩøÂá∫Áé∞ÂºÇÂ∏∏‰πüÁªôÂá∫Âü∫Á°ÄËØÑÂàÜÔºåÁ©∫ÂÜÖÂÆπÁªô0ÂàÜÔºåÊúâÂÜÖÂÆπÁªô1ÂàÜ
        setStageRating('brainstorm', brainstormContent.length > 0 ? 1 : 0);
        setStageRating('outline', outlineContent.length > 0 ? 1 : 0);
        setStageRating('writing', writingContent.length > 0 ? 1 : 0);
        setStageRating('highlight', (brainstormContent + outlineContent + writingContent).length > 0 ? 1 : 0);
        
        // Ëá™Âä®‰øùÂ≠òËØÑÂàÜ
        try {
            await saveRatings();
            Utils.showAlert('AIËØÑÂàÜÂºÇÂ∏∏ÔºåÂ∑≤ÁªôÂá∫ÊúÄ‰ΩéËØÑÂàÜÂπ∂‰øùÂ≠ò', 'warning');
        } catch (saveError) {
            Utils.showAlert('AIËØÑÂàÜÂ§±Ë¥•Ôºå‰øùÂ≠òËØÑÂàÜ‰πüÂ§±Ë¥•Ôºö' + error.message, 'error');
        }
    } finally {
        hideLoading();
    }
}

// ÊòæÁ§∫ËØÑÂàÜÂèçÈ¶à
function displayScoringFeedback(scores, stageReasons) {
    const aiFeedbackDiv = document.getElementById('aiFeedback');
    if (!aiFeedbackDiv) return;
    
    let feedbackHtml = '<div class="ai-scoring-feedback">';
    feedbackHtml += '<h6 class="text-primary mb-3"><i class="fas fa-chart-line me-2"></i>AIËØÑÂàÜËØ¶ÊÉÖ</h6>';
    
    // ÊòæÁ§∫Ê≠£ÊñáËØÑ‰ª∑
    if (scores.writing !== undefined && stageReasons.writing) {
        feedbackHtml += '<div class="feedback-section mb-3">';
        feedbackHtml += '<div class="d-flex align-items-center mb-2">';
        feedbackHtml += '<span class="badge bg-primary me-2">Ê≠£Êñá</span>';
        feedbackHtml += `<span class="fw-bold">${scores.writing}ÂàÜ</span>`;
        feedbackHtml += '</div>';
        feedbackHtml += `<div class="feedback-content text-muted small">${stageReasons.writing}</div>`;
        feedbackHtml += '</div>';
    }
    
    // ÊòæÁ§∫ÁàÜÁÇπËØÑ‰ª∑
    if (scores.highlight !== undefined && stageReasons.highlight) {
        feedbackHtml += '<div class="feedback-section mb-3">';
        feedbackHtml += '<div class="d-flex align-items-center mb-2">';
        feedbackHtml += '<span class="badge bg-warning me-2">ÁàÜÁÇπ</span>';
        feedbackHtml += `<span class="fw-bold">${scores.highlight}ÂàÜ</span>`;
        feedbackHtml += '</div>';
        feedbackHtml += `<div class="feedback-content text-muted small">${stageReasons.highlight}</div>`;
        feedbackHtml += '</div>';
    }
    
    // Â¶ÇÊûúÊúâÊÄªÂàÜÔºåÊòæÁ§∫ÊÄªÂàÜ
    if (scores.writing !== undefined || scores.highlight !== undefined) {
        // ‰ªéDOM‰∏≠Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÊÄªÂàÜ
        const overallScoreElement = document.getElementById('overallScore');
        const totalScore = overallScoreElement ? overallScoreElement.textContent : '0';
        feedbackHtml += '<div class="feedback-section border-top pt-2">';
        feedbackHtml += '<div class="d-flex align-items-center justify-content-between">';
        feedbackHtml += '<span class="fw-bold">ÊÄªÂàÜÔºö</span>';
        feedbackHtml += `<span class="fw-bold text-primary">${totalScore}ÂàÜ</span>`;
        feedbackHtml += '</div>';
        feedbackHtml += '</div>';
    }
    
    feedbackHtml += '</div>';
    
    aiFeedbackDiv.innerHTML = feedbackHtml;
}

// ‰øùÂ≠òËØÑÂàÜ
async function saveRatings() {
    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stage_ratings: stageRatings
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('ËØÑÂàÜÂ∑≤Ëá™Âä®‰øùÂ≠ò');
        }
    } catch (error) {
        console.error('‰øùÂ≠òËØÑÂàÜÂ§±Ë¥•:', error);
    }
}

// Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑËØÑÂàÜ
async function loadSavedRatings() {
    console.log(`[DEBUG] loadSavedRatings called for project ${projectId}`);
    
    try {
        const response = await fetch(`/api/projects/${projectId}`);
        console.log(`[DEBUG] API response status: ${response.status}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log(`[DEBUG] API result:`, result);
            
            if (result.success && result.data) {
                const project = result.data;
                console.log(`[DEBUG] Project data:`, project);
                console.log(`[DEBUG] Project scores field:`, project.scores);
                console.log(`[DEBUG] Project final_score:`, project.final_score);
                
                // ‰ªéÈ°πÁõÆÁöÑscoresÂ≠óÊÆµ‰∏≠Ëß£ÊûêËØÑÂàÜ
                let savedRatings = {
                    brainstorm: 0,
                    outline: 0, 
                    writing: 0,
                    highlight: 0
                };
                
                if (project.scores) {
                    try {
                        const scores = typeof project.scores === 'string' ? JSON.parse(project.scores) : project.scores;
                        console.log(`[DEBUG] Parsed scores:`, scores);
                        
                        savedRatings = {
                            brainstorm: scores.brainstorm || 0,
                            outline: scores.outline || 0,
                            writing: scores.writing || 0,
                            highlight: scores.highlight || 0
                        };
                        console.log(`[DEBUG] Mapped savedRatings:`, savedRatings);
                    } catch (e) {
                        console.warn('Ëß£ÊûêËØÑÂàÜÊï∞ÊçÆÂ§±Ë¥•:', e);
                    }
                }
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄËØÑÂàÜÂØπË±°
                stageRatings = savedRatings;
                console.log(`[DEBUG] Updated global stageRatings:`, stageRatings);
                
                // ËÆæÁΩÆËØÑÂàÜÂπ∂Êõ¥Êñ∞ÊòæÁ§∫
                Object.keys(savedRatings).forEach(stage => {
                    console.log(`[DEBUG] Setting rating for stage ${stage}: ${savedRatings[stage]}`);
                    setStageRating(stage, savedRatings[stage]);
                });
            }
        }
    } catch (error) {
        console.error('Âä†ËΩΩËØÑÂàÜÂ§±Ë¥•:', error);
    }
}

// Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°ÂáΩÊï∞ - ÊîØÊåÅÂ§ö‰∏™Èò∂ÊÆµ
function updateWordCountForStage(stage) {
    const textarea = document.getElementById(stage + 'Content');
    const content = textarea.value;
    const wordCount = content.replace(/\s/g, '').length;
    
    // Êõ¥Êñ∞ÂØπÂ∫îÈò∂ÊÆµÁöÑÂ≠óÊï∞ÁªüËÆ°
    const stageIndex = {'brainstorm': '', 'outline': '2', 'writing': '3'}[stage] || '';
    const countElement = document.getElementById(`currentWordCount${stageIndex}`);
    if (countElement) {
        countElement.textContent = wordCount;
    }
    
    // Êõ¥Êñ∞È°∂ÈÉ®ÊÄªÂ≠óÊï∞
    const totalWordCount = 
        document.getElementById('brainstormContent').value.replace(/\s/g, '').length +
        document.getElementById('outlineContent').value.replace(/\s/g, '').length +
        document.getElementById('writingContent').value.replace(/\s/g, '').length;
    
    document.getElementById('wordCount').textContent = totalWordCount;
    
    // Êõ¥Êñ∞ÂØπÂ∫îÈò∂ÊÆµÁöÑËøõÂ∫¶Êù°
    const progressElement = document.getElementById(`progressBar${stageIndex}`);
    if (progressElement) {
        const progress = Math.min((wordCount / 1000) * 100, 100);
        progressElement.style.width = progress + '%';
    }
}

// ÈáçÂÜôÂ≠óÊï∞ÁªüËÆ°ÂáΩÊï∞
function updateWordCount() {
    updateWordCountForStage(currentStage);
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàê
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] DOMContentLoaded event fired');
    console.log('[DEBUG] Initial stageRatings:', stageRatings);
    console.log('[DEBUG] Project ID:', projectId);
    
    updateWordCount();
    initRatingSystem();
    
    console.log('[DEBUG] About to call loadSavedRatings');
    loadSavedRatings();
    
    // Á°Æ‰øùÊòüÊòüÊòæÁ§∫Ê≠£Á°Æ
    setTimeout(() => {
        console.log('[DEBUG] Timeout callback - checking stageRatings:', stageRatings);
        Object.keys(stageRatings).forEach(stage => {
            console.log(`[DEBUG] Checking stage ${stage} with rating ${stageRatings[stage]}`);
            if (stageRatings[stage] > 0) {
                console.log(`[DEBUG] Re-setting rating for stage ${stage}`);
                setStageRating(stage, stageRatings[stage]);
            }
        });
    }, 100);
    
    // ‰∏∫ÊâÄÊúâÊñáÊú¨Ê°ÜÁªëÂÆöÂ≠óÊï∞ÁªüËÆ°‰∫ã‰ª∂
    ['brainstorm', 'outline', 'writing'].forEach(stage => {
        const textarea = document.getElementById(stage + 'Content');
        if (textarea) {
            textarea.addEventListener('input', function() {
                updateWordCountForStage(stage);
                
                // Ëá™Âä®‰øùÂ≠òÔºàÈùôÈªòÔºâ
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => saveProject(false), 5000);
            });
        }
    });
    
    // ÂÆöÊúüËá™Âä®‰øùÂ≠òÔºàÈùôÈªòÔºâ
    setInterval(() => saveProject(false), 60000); // ÊØèÂàÜÈíüËá™Âä®‰øùÂ≠ò
});

// È°µÈù¢Á¶ªÂºÄÂâç‰øùÂ≠òÔºàÈùôÈªòÔºâ
window.addEventListener('beforeunload', function() {
    saveProject(false);
});

// ÊèíÂÖ•Áª≠ÂÜôÂÜÖÂÆπÂà∞ÂΩìÂâçÊñáÊú¨Ê°Ü
function insertContinuation(text) {
    const textarea = document.getElementById(currentStage + 'Content');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    // Âú®ÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•Áª≠ÂÜôÂÜÖÂÆπ
    const newText = textBefore + text + textAfter;
    textarea.value = newText;
    
    // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆÂà∞ÊèíÂÖ•ÂÜÖÂÆπÁöÑÊú´Â∞æ
    const newCursorPos = cursorPos + text.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
    
    // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂‰ª•Êõ¥Êñ∞Â≠óÊï∞ÁªüËÆ°
    textarea.dispatchEvent(new Event('input'));
    
    Utils.showAlert('Áª≠ÂÜôÂÜÖÂÆπÂ∑≤ÊèíÂÖ•', 'success');
}
</script>
{% endblock %}