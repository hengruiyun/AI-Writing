{% extends "base.html" %}

{% block title %}å†™ä½œ - {{ project.title }}{% endblock %}

{% block content %}
<div class="writing-container">
    <!-- é¡¹ç›®ä¿¡æ¯æ  -->
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3>{{ project.title }}</h3>
                <p class="text-muted mb-0">{{ project.subject }} Â· {{ project.article_type }}</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="word-count">
                    <small class="text-muted">å­—æ•°ï¼š</small>
                    <span id="wordCount">{{ project.word_count }}</span>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        æ“ä½œ
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="saveProject(true)">
                            <i class="fas fa-save"></i> ä¿å­˜
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="evaluateProject()">
                            <i class="fas fa-check-circle"></i> å®Œæˆè¯„åˆ†
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.projects') }}">
                            <i class="fas fa-arrow-left"></i> è¿”å›é¡¹ç›®åˆ—è¡¨
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- é¢˜ç›®æ˜¾ç¤º -->
        <div class="topic-display">
            <div class="topic-card">
                <h6 class="topic-label">å†™ä½œé¢˜ç›®</h6>
                <p class="topic-text">{{ project.topic }}</p>
            </div>
        </div>
    </div>
    
    <!-- å†™ä½œé˜¶æ®µå¯¼èˆª -->
    <div class="writing-stages">
        <div class="stage-nav">
            <button class="stage-btn active" data-stage="brainstorm">
                <i class="fas fa-lightbulb"></i>
                <span>æ„æ€</span>
            </button>
            <button class="stage-btn" data-stage="outline">
                <i class="fas fa-list"></i>
                <span>æçº²</span>
            </button>
            <button class="stage-btn" data-stage="writing">
                <i class="fas fa-pen"></i>
                <span>æ­£æ–‡</span>
            </button>
        </div>
    </div>
    
    <!-- å†™ä½œå†…å®¹åŒºåŸŸ -->
    <div class="writing-content">
        <div class="row g-3">
            <div class="col-xl-8 col-lg-7 col-md-8">
                <!-- æ„æ€é˜¶æ®µ -->
                <div class="stage-content active" id="brainstorm-stage">
                    <div class="stage-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-lightbulb text-warning me-2"></i>æ„æ€é˜¶æ®µ</h5>
                                <p class="text-muted mb-0">æ•´ç†æ€è·¯ï¼Œè®°å½•çµæ„Ÿå’Œæƒ³æ³•</p>
                            </div>
                            <div class="stage-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="getAISuggestions()">
                                    <i class="fas fa-magic"></i> AIå»ºè®®
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveProject(true)">
                                    <i class="fas fa-save"></i> ä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea class="form-control stage-textarea" id="brainstormContent" 
                                  placeholder="ğŸ’¡ åœ¨è¿™é‡Œè®°å½•æ‚¨çš„æƒ³æ³•ã€çµæ„Ÿå’Œæ„æ€...&#10;&#10;ğŸ¯ å†™ä½œæç¤ºï¼š&#10;â€¢ å›´ç»•é¢˜ç›®æ ¸å¿ƒæ€è€ƒå¤šä¸ªè§’åº¦&#10;â€¢ æ”¶é›†ç›¸å…³çš„äº‹ä¾‹å’Œç´ æ&#10;â€¢ ç¡®å®šæ–‡ç« çš„ä¸»è¦è§‚ç‚¹&#10;â€¢ è€ƒè™‘è¯»è€…çš„å…´è¶£ç‚¹&#10;â€¢ æ€è€ƒæ–‡ç« çš„åˆ›æ–°ä¹‹å¤„">{{ project.brainstorm_content or '' }}</textarea>
                        <div class="textarea-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                æ„æ€é˜¶æ®µé‡åœ¨å‘æ•£æ€ç»´ï¼Œè®°å½•æ‰€æœ‰ç›¸å…³æƒ³æ³•
                            </small>
                        </div>
                    </div>
                    
                    <!-- æ„æ€é˜¶æ®µçš„ç»Ÿè®¡å’Œè¯„åˆ† -->
                    <div class="stage-bottom-panel mt-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <!-- å†™ä½œç»Ÿè®¡ -->
                                <div class="writing-stats">
                                    <h6><i class="fas fa-chart-bar text-info me-2"></i>å†™ä½œç»Ÿè®¡</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">å½“å‰å­—æ•°</span>
                                                <span class="stat-value" id="currentWordCount">0</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-target"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ç›®æ ‡å­—æ•°</span>
                                                <span class="stat-value">800-1000</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">å®Œæˆåº¦</span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- æ„æ€è¯„åˆ† -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-star text-warning me-2"></i>æ„æ€è¯„åˆ†</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="brainstorm">
                                                <span class="star" data-value="1">â˜…</span>
                                                <span class="star" data-value="2">â˜…</span>
                                                <span class="star" data-value="3">â˜…</span>
                                                <span class="star" data-value="4">â˜…</span>
                                                <span class="star" data-value="5">â˜…</span>
                                            </div>
                                            <span class="rating-text" id="brainstormRatingText">æœªè¯„åˆ†</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æçº²é˜¶æ®µ -->
                <div class="stage-content" id="outline-stage">
                    <div class="stage-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-list text-info me-2"></i>æçº²é˜¶æ®µ</h5>
                                <p class="text-muted mb-0">æ•´ç†ç»“æ„ï¼Œåˆ¶å®šå†™ä½œå¤§çº²</p>
                            </div>
                            <div class="stage-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="getAISuggestions()">
                                    <i class="fas fa-magic"></i> AIå»ºè®®
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveProject(true)">
                                    <i class="fas fa-save"></i> ä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea class="form-control stage-textarea" id="outlineContent" 
                                  placeholder="ğŸ“ åœ¨è¿™é‡Œåˆ¶å®šæ‚¨çš„å†™ä½œå¤§çº²...&#10;&#10;ğŸ¯ æçº²è¦ç‚¹ï¼š&#10;â€¢ ç¡®å®šæ–‡ç« çš„åŸºæœ¬ç»“æ„ï¼ˆæ€»åˆ†æ€»ç­‰ï¼‰&#10;â€¢ å®‰æ’å„æ®µè½çš„ä¸»è¦å†…å®¹&#10;â€¢ ç†æ¸…æ®µè½é—´çš„é€»è¾‘å…³ç³»&#10;â€¢ è®¾è®¡å¥½å¼€å¤´å’Œç»“å°¾&#10;â€¢ ç¡®ä¿å†…å®¹å±‚æ¬¡åˆ†æ˜">{{ project.outline_content or '' }}</textarea>
                        <div class="textarea-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                æçº²é˜¶æ®µé‡åœ¨ç†æ¸…ç»“æ„ï¼Œç¡®ä¿é€»è¾‘æ¸…æ™°
                            </small>
                        </div>
                    </div>
                    
                    <!-- æçº²é˜¶æ®µçš„ç»Ÿè®¡å’Œè¯„åˆ† -->
                    <div class="stage-bottom-panel mt-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <!-- å†™ä½œç»Ÿè®¡ -->
                                <div class="writing-stats">
                                    <h6><i class="fas fa-chart-bar text-info me-2"></i>å†™ä½œç»Ÿè®¡</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">å½“å‰å­—æ•°</span>
                                                <span class="stat-value" id="currentWordCount2">0</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-target"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ç›®æ ‡å­—æ•°</span>
                                                <span class="stat-value">800-1000</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">å®Œæˆåº¦</span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar" id="progressBar2" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- æçº²è¯„åˆ† -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-star text-warning me-2"></i>æçº²è¯„åˆ†</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="outline">
                                                <span class="star" data-value="1">â˜…</span>
                                                <span class="star" data-value="2">â˜…</span>
                                                <span class="star" data-value="3">â˜…</span>
                                                <span class="star" data-value="4">â˜…</span>
                                                <span class="star" data-value="5">â˜…</span>
                                            </div>
                                            <span class="rating-text" id="outlineRatingText">æœªè¯„åˆ†</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ­£æ–‡é˜¶æ®µ -->
                <div class="stage-content" id="writing-stage">
                    <div class="stage-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-pen text-success me-2"></i>æ­£æ–‡å†™ä½œ</h5>
                                <p class="text-muted mb-0">å®Œæˆæ–‡ç« æ­£æ–‡ï¼Œè¡¨è¾¾æ‚¨çš„è§‚ç‚¹</p>
                            </div>
                            <div class="stage-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="getAISuggestions()">
                                    <i class="fas fa-magic"></i> AIå»ºè®®
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="saveProject(true)">
                                    <i class="fas fa-save"></i> ä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea class="form-control stage-textarea" id="writingContent" 
                                  placeholder="âœï¸ åœ¨è¿™é‡Œå†™ä½œæ‚¨çš„æ–‡ç« æ­£æ–‡...&#10;&#10;ğŸ¯ å†™ä½œè¦ç‚¹ï¼š&#10;â€¢ ç”¨è¯å‡†ç¡®ç”ŸåŠ¨&#10;â€¢ å¥å¼å¯Œæœ‰å˜åŒ–&#10;â€¢ é€‚å½“è¿ç”¨ä¿®è¾æ‰‹æ³•&#10;â€¢ æ³¨æ„æ®µè½é—´çš„è¿‡æ¸¡&#10;â€¢ ä¿æŒè¯­è¨€é£æ ¼ç»Ÿä¸€">{{ project.writing_content or '' }}</textarea>
                        <div class="textarea-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                æ­£æ–‡é˜¶æ®µé‡åœ¨è¡¨è¾¾ï¼Œæ³¨æ„è¯­è¨€çš„å‡†ç¡®æ€§å’Œç”ŸåŠ¨æ€§
                            </small>
                        </div>
                    </div>
                    
                    <!-- æ­£æ–‡é˜¶æ®µçš„ç»Ÿè®¡å’Œè¯„åˆ† -->
                    <div class="stage-bottom-panel mt-3">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <!-- å†™ä½œç»Ÿè®¡ -->
                                <div class="writing-stats">
                                    <h6><i class="fas fa-chart-bar text-info me-2"></i>å†™ä½œç»Ÿè®¡</h6>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">å½“å‰å­—æ•°</span>
                                                <span class="stat-value" id="currentWordCount3">0</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-target"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">ç›®æ ‡å­—æ•°</span>
                                                <span class="stat-value">800-1000</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-icon">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <div class="stat-content">
                                                <span class="stat-label">å®Œæˆåº¦</span>
                                                <div class="progress mt-1">
                                                    <div class="progress-bar" id="progressBar3" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- æ­£æ–‡è¯„åˆ† -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-star text-warning me-2"></i>æ­£æ–‡è¯„åˆ†</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="writing">
                                                <span class="star" data-value="1">â˜…</span>
                                                <span class="star" data-value="2">â˜…</span>
                                                <span class="star" data-value="3">â˜…</span>
                                                <span class="star" data-value="4">â˜…</span>
                                                <span class="star" data-value="5">â˜…</span>
                                            </div>
                                            <span class="rating-text" id="writingRatingText">æœªè¯„åˆ†</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <!-- çˆ†ç‚¹è¯„åˆ† -->
                                <div class="stage-rating">
                                    <h6><i class="fas fa-fire text-danger me-2"></i>çˆ†ç‚¹è¯„åˆ†</h6>
                                    <div class="rating-item">
                                        <div class="rating-stars">
                                            <div class="star-rating" data-stage="highlight">
                                                <span class="star" data-value="1">â˜…</span>
                                                <span class="star" data-value="2">â˜…</span>
                                                <span class="star" data-value="3">â˜…</span>
                                                <span class="star" data-value="4">â˜…</span>
                                                <span class="star" data-value="5">â˜…</span>
                                            </div>
                                            <span class="rating-text" id="highlightRatingText">æœªè¯„åˆ†</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ€»ä½“è¯„åˆ†å’Œæ“ä½œ -->
                <div class="overall-summary mt-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <!-- æ€»ä½“è¯„åˆ† -->
                                    <div class="overall-rating">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6><i class="fas fa-trophy text-warning me-2"></i>æ€»ä½“è¯„åˆ†</h6>
                                                <div class="text-muted small">å¹³å‡åˆ†æ•°</div>
                                            </div>
                                            <div class="overall-score">
                                                <span class="score-number" id="overallScore">0.0</span>
                                                <span class="score-max">/100</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- è¯„åˆ†æ“ä½œ -->
                                    <div class="rating-actions">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="getAIRating()">
                                            <i class="fas fa-robot me-1"></i> AIæ™ºèƒ½è¯„åˆ†
                                        </button>
                                        <button class="btn btn-outline-success btn-sm w-100" onclick="saveRatings()">
                                            <i class="fas fa-save me-1"></i> ä¿å­˜è¯„åˆ†
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-4 col-lg-5 col-md-4">
                <!-- AIåŠ©æ‰‹é¢æ¿ -->
                <div class="ai-assistant">
                    <div class="ai-header">
                        <h6><i class="fas fa-robot text-primary"></i> AIå†™ä½œåŠ©æ‰‹</h6>
                        <small class="text-muted">æ™ºèƒ½åˆ†æä¸å»ºè®®</small>
                    </div>
                    
                    <div class="ai-content">
                        <div class="ai-actions mb-3">
                            <button class="btn btn-primary btn-sm w-100 mb-2" onclick="getAIAnalysis()">
                                <i class="fas fa-search me-1"></i> åˆ†æå½“å‰å†…å®¹
                            </button>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="getAISuggestions()">
                                <i class="fas fa-lightbulb me-1"></i> è·å–å†™ä½œå»ºè®®
                            </button>
                        </div>
                        
                        <div class="ai-feedback" id="aiFeedback">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-robot fa-2x mb-2 text-primary"></i>
                                <p class="mb-0">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–AIå»ºè®®</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½æ¨¡æ€æ¡† -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">å¤„ç†ä¸­...</span>
                </div>
                <p class="mb-0" id="loadingText">AIæ­£åœ¨åˆ†ææ‚¨çš„å†…å®¹...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
.writing-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

.project-header {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.topic-display {
    margin-top: 15px;
}

.topic-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #007bff;
}

.topic-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.topic-text {
    font-size: 1.1rem;
    margin-bottom: 0;
    color: #333;
}

.writing-stages {
    margin-bottom: 20px;
}

.stage-nav {
    display: flex;
    gap: 10px;
    justify-content: flex-start;
}

.stage-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px 25px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    min-width: 120px;
}

.stage-btn:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.stage-btn.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
}

.stage-btn i {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.writing-content {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stage-content {
    display: none;
}

.stage-content.active {
    display: block;
}

.stage-header {
    margin-bottom: 20px;
}

/* æ–‡æœ¬è¾“å…¥åŒºåŸŸå®¹å™¨ */
.textarea-container {
    position: relative;
    margin-top: 15px;
}

.stage-textarea {
    min-height: 600px;
    max-height: 90vh;
    height: 600px;
    resize: vertical;
    font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px;
    line-height: 1.8;
    padding: 25px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    width: 100%;
}

.stage-textarea:focus {
    border-color: #007bff;
    box-shadow: 0 4px 16px rgba(0,123,255,0.15);
    outline: none;
}

.textarea-footer {
    margin-top: 8px;
    padding: 0 5px;
}

/* é˜¶æ®µå¤´éƒ¨æ ·å¼ */
.stage-header {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 0;
    border: 1px solid #e9ecef;
}

.stage-actions .btn {
    font-size: 0.875rem;
    padding: 6px 12px;
}

.ai-assistant {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    position: sticky;
    top: 20px;
    height: calc(260vh - 150px);
    display: flex;
    flex-direction: column;
}

.ai-header {
    margin-bottom: 15px;
    text-align: center;
}

.ai-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.ai-feedback {
    flex: 1;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    height: calc(260vh - 300px);
    min-height: 1000px;
}

.writing-stats {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

/* å†™ä½œç»Ÿè®¡æ ·å¼ */
.stats-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.stat-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #007bff;
    color: white;
    border-radius: 8px;
    margin-right: 12px;
    font-size: 1.1rem;
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 2px;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
}

/* è¯„åˆ†ç³»ç»Ÿæ ·å¼ */
.rating-system {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.rating-header {
    margin-bottom: 15px;
}

.rating-header h6 {
    margin-bottom: 5px;
    font-weight: 600;
}

.rating-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #ffc107;
}

.rating-label {
    display: flex;
    align-items: center;
    font-weight: 500;
    margin-bottom: 8px;
}

.rating-stars {
    display: flex;
    align-items: center;
    gap: 10px;
}

.star-rating {
    display: flex;
    gap: 2px;
}

.star {
    font-size: 1.5rem;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s ease;
    user-select: none;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.star.active {
    color: #ff9800;
}

.rating-text {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.overall-rating {
    text-align: center;
}

.overall-score {
    font-size: 1.5rem;
    font-weight: bold;
}

.score-number {
    color: #28a745;
}

.score-max {
    color: #6c757d;
    font-size: 1rem;
}

.rating-actions {
    margin-top: 15px;
}

.rating-actions .btn {
    font-size: 0.9rem;
    padding: 10px 15px;
}

/* åé¦ˆå†…å®¹æ ·å¼ */
.feedback-section {
    margin-bottom: 20px;
}

.feedback-section h6 {
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #e9ecef;
}

.feedback-section ul {
    margin-bottom: 0;
}

.feedback-section li {
    padding: 5px 0;
    border-bottom: 1px solid #f8f9fa;
}

.feedback-section li:last-child {
    border-bottom: none;
}

/* AIè¯„åˆ†åé¦ˆæ ·å¼ */
.ai-scoring-feedback {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #007bff;
}

.ai-scoring-feedback .feedback-section {
    background: white;
    border-radius: 6px;
    padding: 12px;
    border: 1px solid #e9ecef;
}

.ai-scoring-feedback .feedback-content {
    line-height: 1.5;
    white-space: pre-wrap;
}

.ai-scoring-feedback .badge {
    font-size: 0.75rem;
}

.ai-scoring-feedback h6 {
    color: #007bff;
    font-weight: 600;
    margin-bottom: 15px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
}

.stat-label {
    font-weight: 500;
}

.progress {
    width: 100px;
    height: 8px;
}

.word-count {
    font-size: 1.1rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1200px) {
    .writing-container {
        padding: 15px;
    }
    
    .stage-textarea {
        min-height: 600px;
        font-size: 15px;
        padding: 20px;
    }
    
    .ai-assistant {
        position: relative;
        top: auto;
    }
    
    .stage-bottom-panel {
        margin-top: 15px;
    }
}

@media (max-width: 768px) {
    .writing-container {
        padding: 10px;
    }
    
    .stage-nav {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .stage-btn {
        width: 100%;
        max-width: 200px;
        padding: 12px 20px;
    }
    
    .stage-btn i {
        font-size: 1.2rem;
    }
    
    .stage-header {
        padding: 15px;
    }
    
    .stage-header .d-flex {
        flex-direction: column;
        gap: 15px;
    }
    
    .stage-actions {
        display: flex;
        gap: 10px;
        width: 100%;
    }
    
    .stage-actions .btn {
        flex: 1;
        font-size: 0.8rem;
        padding: 8px 12px;
    }
    
    .stage-textarea {
        min-height: 500px;
        font-size: 14px;
        padding: 15px;
    }
    
    .stats-grid {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .stat-item {
        flex: 1;
        min-width: 120px;
        padding: 8px;
    }
    
    .stat-icon {
        width: 30px;
        height: 30px;
        margin-right: 8px;
        font-size: 0.9rem;
    }
    
    .stat-value {
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .project-header {
        padding: 15px;
    }
    
    .project-header .d-flex {
        flex-direction: column;
        gap: 15px;
    }
    
    .stage-textarea {
        min-height: 400px;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .stats-grid {
        flex-direction: column;
    }
    
    .stat-item {
        min-width: auto;
    }
}

/* é˜¶æ®µåº•éƒ¨é¢æ¿æ ·å¼ */
.stage-bottom-panel {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #e9ecef;
    margin-top: 20px;
}

.stage-rating {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    height: 100%;
}

.writing-stats {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    height: 100%;
}

.stats-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 1.1rem;
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
}

/* è¯„åˆ†æ˜Ÿæ˜Ÿæ ·å¼ */
.rating-stars {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.star-rating {
    display: flex;
    gap: 5px;
}

.star {
    font-size: 1.5rem;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.rating-text {
    font-size: 0.9rem;
    color: #6c757d;
    margin-left: 10px;
}

/* æ€»ä½“æ‘˜è¦æ ·å¼ */
.overall-summary .card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.overall-rating {
    text-align: center;
}

.overall-score {
    font-size: 1.8rem;
    font-weight: bold;
    margin-top: 10px;
}

.score-number {
    color: #28a745;
}

.score-max {
    color: #6c757d;
    font-size: 1.2rem;
}

.rating-actions .btn {
    font-size: 0.9rem;
    padding: 10px 15px;
}

/* ç¤ºèŒƒè¯­å¥æ ·å¼ */
.example-sentences {
    max-height: 300px;
    overflow-y: auto;
}

.example-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.example-item:hover {
    background: #e9ecef;
    border-color: #dee2e6;
}

.example-text {
    font-style: italic;
    color: #495057;
    margin-bottom: 8px;
    line-height: 1.5;
    font-size: 0.95rem;
}

.example-item .btn {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 4px;
}

.example-item .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ç®€åŒ–çš„Utilså¯¹è±¡
window.Utils = {
    showAlert: function(message, type) {
        // å°è¯•ä½¿ç”¨å…¨å±€alertå…ƒç´ 
        const alertElement = document.getElementById('globalAlert');
        if (alertElement) {
            const alertMessage = document.getElementById('alertMessage');
            const alertIcon = document.getElementById('alertIcon');
            if (alertMessage && alertIcon) {
                alertMessage.textContent = message;
                alertIcon.className = 'fas fa-info-circle me-2';
                alertElement.className = 'alert alert-' + (type === 'error' ? 'danger' : type) + ' alert-dismissible fade show';
                alertElement.style.display = 'block';
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
                return;
            }
        }
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æµè§ˆå™¨alert
        alert(message);
    }
};

const projectId = {{ project.id }};
let currentStage = 'brainstorm';
let autoSaveTimer = null;

// é˜¶æ®µåˆ‡æ¢
document.querySelectorAll('.stage-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const stage = this.dataset.stage;
        switchStage(stage);
    });
});

function switchStage(stage) {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.stage-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-stage="${stage}"]`).classList.add('active');
    
    // æ›´æ–°å†…å®¹åŒºåŸŸ
    document.querySelectorAll('.stage-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${stage}-stage`).classList.add('active');
    
    currentStage = stage;
    updateWordCount();
}

// å­—æ•°ç»Ÿè®¡
function updateWordCount() {
    const textarea = document.getElementById(currentStage + 'Content');
    const content = textarea.value;
    const wordCount = content.replace(/\s/g, '').length;
    
    document.getElementById('currentWordCount').textContent = wordCount;
    document.getElementById('wordCount').textContent = wordCount;
    
    // æ›´æ–°è¿›åº¦æ¡
    const progress = Math.min((wordCount / 1000) * 100, 100);
    document.getElementById('progressBar').style.width = progress + '%';
}

// ç»‘å®šæ–‡æœ¬æ¡†äº‹ä»¶
document.querySelectorAll('.stage-textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        updateWordCount();
        
        // è‡ªåŠ¨ä¿å­˜
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveProject, 5000);
    });
});

// ä¿å­˜é¡¹ç›®
async function saveProject(showSuccessAlert = false) {
    try {
        const data = {
            brainstorm_content: document.getElementById('brainstormContent').value,
            outline_content: document.getElementById('outlineContent').value,
            writing_content: document.getElementById('writingContent').value,
            status: 'writing'
        };
        
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            if (showSuccessAlert) {
                Utils.showAlert('ä¿å­˜æˆåŠŸ', 'success');
            } else {
                // é™é»˜ä¿å­˜ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
                console.log('é¡¹ç›®å·²è‡ªåŠ¨ä¿å­˜');
            }
        } else {
            Utils.showAlert('ä¿å­˜å¤±è´¥ï¼š' + result.message, 'error');
        }
    } catch (error) {
        console.error('ä¿å­˜é”™è¯¯:', error);
        if (showSuccessAlert) {
            Utils.showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        }
    }
}

// AIåˆ†æ
async function getAIAnalysis() {
    const textarea = document.getElementById(currentStage + 'Content');
    const content = textarea.value.trim();
    
    if (!content) {
        Utils.showAlert('è¯·å…ˆè¾“å…¥å†…å®¹', 'warning');
        return;
    }
    
    // è·å–AIè®¾ç½®
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('è¯·å…ˆé…ç½®AIè®¾ç½®', 'warning');
        return;
    }
    
    // æ„å»ºAIè®¾ç½®å¯¹è±¡
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    showLoading('AIæ­£åœ¨åˆ†ææ‚¨çš„å†…å®¹...');
    
    try {
        const response = await fetch('/api/ai/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                stage: currentStage,
                content: content,
                ai_provider: parsedSettings.provider,
                ai_model: parsedSettings.model,
                ai_base_url: parsedSettings.base_url,
                ai_api_key: parsedSettings.api_key
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            displayAIFeedback(result.data);
        } else {
            Utils.showAlert('åˆ†æå¤±è´¥ï¼š' + result.message, 'error');
        }
    } catch (error) {
        console.error('AIåˆ†æé”™è¯¯:', error);
        Utils.showAlert('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    } finally {
        hideLoading();
    }
}

// AIå»ºè®®
async function getAISuggestions() {
    const textarea = document.getElementById(currentStage + 'Content');
    const content = textarea.value.trim();
    
    // è·å–AIè®¾ç½®
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('è¯·å…ˆé…ç½®AIè®¾ç½®', 'warning');
        return;
    }
    
    // æ„å»ºAIè®¾ç½®å¯¹è±¡
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    showLoading('AIæ­£åœ¨ç”Ÿæˆå»ºè®®...');
    
    try {
        const topicElement = document.querySelector('.topic-text');
        const topic = topicElement ? topicElement.textContent : '';
        
        // è·å–é¡¹ç›®ä¿¡æ¯ä»¥è·å–å¹´çº§å’Œå­¦ç§‘
        const projectResponse = await fetch(`/api/projects/${projectId}`);
        let grade = 'åˆä¸­';
        let subject = 'è¯­æ–‡';
        let language = 'ä¸­æ–‡';
        
        if (projectResponse.ok) {
            const projectData = await projectResponse.json();
            if (projectData.success && projectData.data) {
                grade = projectData.data.grade || 'åˆä¸­';
                subject = projectData.data.subject || 'è¯­æ–‡';
                // æ ¹æ®å­¦ç§‘åˆ¤æ–­è¯­ç§
                language = subject.includes('è‹±è¯­') ? 'è‹±è¯­' : 'ä¸­æ–‡';
            }
        }
        
        // è·å–å½“å‰é˜¶æ®µçš„ä¸­æ–‡æè¿°
        const stageMap = {
            'brainstorm': 'æ„æ€',
            'outline': 'æçº²',
            'writing': 'æ­£æ–‡'
        };
        const currentStageText = stageMap[currentStage] || currentStage;
        
        // è·å–æ‰€æœ‰æ–‡æœ¬æ¡†çš„å®Œæ•´å†…å®¹
        const brainstormContent = document.getElementById('brainstormContent').value.trim();
        const outlineContent = document.getElementById('outlineContent').value.trim();
        const writingContent = document.getElementById('writingContent').value.trim();
        
        const response = await fetch('/api/ai/suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                stage: currentStage,
                current_stage_text: currentStageText,
                content: content,
                full_content: {
                    brainstorm: brainstormContent,
                    outline: outlineContent,
                    writing: writingContent
                },
                topic: topic,
                grade: grade,
                subject: subject,
                language: language,
                ai_provider: parsedSettings.provider,
                ai_model: parsedSettings.model,
                ai_base_url: parsedSettings.base_url,
                ai_api_key: parsedSettings.api_key
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('AIå»ºè®®å“åº”æ•°æ®:', result.data);
            if (result.data.continuation_sets) {
                console.log('ç»­å†™å»ºè®®æ•°æ®:', result.data.continuation_sets);
            }
            displayAISuggestions(result.data);
        } else {
            Utils.showAlert('è·å–å»ºè®®å¤±è´¥ï¼š' + result.message, 'error');
        }
    } catch (error) {
        console.error('AIå»ºè®®é”™è¯¯:', error);
        Utils.showAlert('è·å–å»ºè®®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
    } finally {
        hideLoading();
    }
}

// æ˜¾ç¤ºAIå»ºè®®
function displayAISuggestions(suggestions) {
    const feedbackDiv = document.getElementById('aiFeedback');
    
    let html = '<div class="ai-suggestions">';
    
    // å½“å‰çŠ¶æ€ç‚¹è¯„
    if (suggestions.current_status_critique) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-info"><i class="fas fa-search"></i> å½“å‰çŠ¶æ€ç‚¹è¯„</h6>';
        html += `<div class="alert alert-info">${suggestions.current_status_critique}</div>`;
        html += '</div>';
    }
    
    // é˜¶æ®µç‰¹å®šå»ºè®®
    if (suggestions.stage_tips && suggestions.stage_tips.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += `<h6 class="text-primary"><i class="fas fa-lightbulb"></i> ${getStageTitle(currentStage)}å»ºè®®</h6>`;
        html += '<ul class="list-unstyled">';
        suggestions.stage_tips.forEach(tip => {
            html += `<li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>${tip}</li>`;
        });
        html += '</ul></div>';
    }
    
    // ç»­å†™å»ºè®®ï¼ˆ3å¥—ï¼Œæ¯å¥—2å¥è¯ï¼‰
    if (suggestions.continuation_sets && suggestions.continuation_sets.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-success"><i class="fas fa-pen-fancy"></i> ç»­å†™å»ºè®®</h6>';
        html += '<div class="continuation-sets">';
        suggestions.continuation_sets.forEach((set, index) => {
            html += `<div class="continuation-set mb-3 p-3 border rounded">`;
            html += `<div class="fw-bold mb-2">ç»­å†™æ–¹æ¡ˆ ${index + 1}ï¼š</div>`;
            if (set.sentences && set.sentences.length >= 2) {
                html += '<div class="continuation-sentences">';
                set.sentences.slice(0, 2).forEach((sentence, sentIndex) => {
                    html += `<div class="sentence-item mb-2">`;
                    html += `<span class="sentence-number badge bg-primary me-2">${sentIndex + 1}</span>`;
                    html += `<span class="sentence-text">${sentence}</span>`;
                    html += '</div>';
                });
                html += '</div>';
                const combinedText = set.sentences.slice(0, 2).join(' ');
                html += `<button class="btn btn-sm btn-outline-success mt-2" onclick="insertContinuation('${combinedText.replace(/'/g, "\\'")}')"`;
                html += `><i class="fas fa-plus me-1"></i>æ’å…¥è¿™å¥—ç»­å†™</button>`;
            }
            html += '</div>';
        });
        html += '</div></div>';
    }
    
    // ç¤ºèŒƒè¯­å¥
    if (suggestions.example_sentences && suggestions.example_sentences.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-danger"><i class="fas fa-quote-left"></i> ç¤ºèŒƒè¯­å¥</h6>';
        html += '<div class="example-sentences">';
        suggestions.example_sentences.forEach((sentence, index) => {
            html += `<div class="example-item mb-2">
                <div class="example-text">${sentence}</div>
                <button class="btn btn-sm btn-outline-primary mt-1" onclick="insertExample('${sentence.replace(/'/g, "\\'")}')">
                    <i class="fas fa-plus me-1"></i>æ’å…¥
                </button>
            </div>`;
        });
        html += '</div></div>';
    }
    
    // å†…å®¹å»ºè®®
    if (suggestions.content_suggestions && suggestions.content_suggestions.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-success"><i class="fas fa-pen"></i> å†…å®¹å»ºè®®</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.content_suggestions.forEach(suggestion => {
            html += `<li class="mb-2"><i class="fas fa-plus text-success me-2"></i>${suggestion}</li>`;
        });
        html += '</ul></div>';
    }
    
    // å†™ä½œæŠ€å·§
    if (suggestions.writing_tips && suggestions.writing_tips.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-info"><i class="fas fa-magic"></i> å†™ä½œæŠ€å·§</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.writing_tips.forEach(tip => {
            html += `<li class="mb-2"><i class="fas fa-star text-info me-2"></i>${tip}</li>`;
        });
        html += '</ul></div>';
    }
    
    // å‚è€ƒç´ æ
    if (suggestions.references && suggestions.references.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-secondary"><i class="fas fa-book"></i> å‚è€ƒç´ æ</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.references.forEach(ref => {
            html += `<li class="mb-2"><i class="fas fa-bookmark text-secondary me-2"></i>${ref}</li>`;
        });
        html += '</ul></div>';
    }
    
    // ä¸‹ä¸€æ­¥å»ºè®®
    if (suggestions.next_steps && suggestions.next_steps.length > 0) {
        html += '<div class="feedback-section">';
        html += '<h6 class="text-warning"><i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥</h6>';
        html += '<ul class="list-unstyled">';
        suggestions.next_steps.forEach(step => {
            html += `<li class="mb-2"><i class="fas fa-chevron-right text-warning me-2"></i>${step}</li>`;
        });
        html += '</ul></div>';
    }
    
    html += '</div>';
    
    feedbackDiv.innerHTML = html;
}

// æ’å…¥ç¤ºèŒƒè¯­å¥åˆ°å½“å‰æ–‡æœ¬æ¡†
function insertExample(sentence) {
    const textarea = document.getElementById(currentStage + 'Content');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ç¤ºèŒƒè¯­å¥
    const newText = textBefore + sentence + textAfter;
    textarea.value = newText;
    
    // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°æ’å…¥æ–‡æœ¬çš„æœ«å°¾
    const newCursorPos = cursorPos + sentence.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    
    // èšç„¦åˆ°æ–‡æœ¬æ¡†
    textarea.focus();
    
    // æ›´æ–°å­—æ•°ç»Ÿè®¡
    updateWordCountForStage(currentStage);
    
    // æ˜¾ç¤ºç®€çŸ­æç¤º
    Utils.showAlert('å·²æ’å…¥ç¤ºèŒƒè¯­å¥', 'info', 2000);
    
    // è‡ªåŠ¨ä¿å­˜ï¼ˆé™é»˜ï¼‰
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(() => saveProject(false), 2000);
}

// è·å–é˜¶æ®µæ ‡é¢˜
function getStageTitle(stage) {
    switch(stage) {
        case 'brainstorm': return 'æ„æ€';
        case 'outline': return 'æçº²';
        case 'writing': return 'æ­£æ–‡';
        default: return 'å†™ä½œ';
    }
}

// æ˜¾ç¤ºAIåé¦ˆ
function displayAIFeedback(feedback) {
    const feedbackDiv = document.getElementById('aiFeedback');
    
    let html = '<div class="ai-analysis">';
    
    if (feedback.strengths && feedback.strengths.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-success"><i class="fas fa-thumbs-up"></i> ä¼˜ç‚¹</h6>';
        html += '<ul class="list-unstyled">';
        feedback.strengths.forEach(strength => {
            html += `<li class="mb-1"><i class="fas fa-check text-success me-2"></i>${strength}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (feedback.issues && feedback.issues.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> éœ€è¦æ”¹è¿›</h6>';
        html += '<ul class="list-unstyled">';
        feedback.issues.forEach(issue => {
            html += `<li class="mb-1"><i class="fas fa-minus text-warning me-2"></i>${issue}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (feedback.suggestions && feedback.suggestions.length > 0) {
        html += '<div class="feedback-section mb-3">';
        html += '<h6 class="text-primary"><i class="fas fa-lightbulb"></i> å»ºè®®</h6>';
        html += '<ul class="list-unstyled">';
        feedback.suggestions.forEach(suggestion => {
            html += `<li class="mb-1"><i class="fas fa-arrow-right text-primary me-2"></i>${suggestion}</li>`;
        });
        html += '</ul></div>';
    }
    
    if (feedback.analysis) {
        html += '<div class="feedback-section">';
        html += '<h6><i class="fas fa-comment"></i> åˆ†æ</h6>';
        html += `<p class="mb-0">${feedback.analysis}</p>`;
        html += '</div>';
    }
    
    html += '</div>';
    
    feedbackDiv.innerHTML = html;
}

// å®Œæˆè¯„åˆ†
async function evaluateProject() {
    const writingContent = document.getElementById('writingContent').value.trim();
    
    if (!writingContent) {
        Utils.showAlert('è¯·å…ˆå®Œæˆæ­£æ–‡å†™ä½œ', 'warning');
        return;
    }
    
    // è·å–AIè®¾ç½®
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('è¯·å…ˆé…ç½®AIè®¾ç½®', 'warning');
        return;
    }
    
    // æ„å»ºAIè®¾ç½®å¯¹è±¡
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    if (confirm('ç¡®å®šè¦å®Œæˆå†™ä½œå¹¶è¿›è¡Œè¯„åˆ†å—ï¼Ÿ')) {
        showLoading('AIæ­£åœ¨è¯„åˆ†ä¸­...');
        
        try {
            const response = await fetch('/api/ai/evaluate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project_id: projectId,
                    ai_provider: parsedSettings.provider,
                    ai_model: parsedSettings.model,
                    ai_base_url: parsedSettings.base_url,
                    ai_api_key: parsedSettings.api_key
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                Utils.showAlert('è¯„åˆ†å®Œæˆï¼', 'success');
                setTimeout(() => {
                    window.location.href = `/review/${projectId}`;
                }, 1500);
            } else {
                Utils.showAlert('è¯„åˆ†å¤±è´¥ï¼š' + result.message, 'error');
            }
        } catch (error) {
            Utils.showAlert('è¯„åˆ†å¤±è´¥ï¼š' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) {
        modal.hide();
    }
}

// è¯„åˆ†ç³»ç»Ÿç›¸å…³åŠŸèƒ½
let stageRatings = {
    brainstorm: 0,
    outline: 0,
    writing: 0,
    highlight: 0
};

// åˆå§‹åŒ–è¯„åˆ†ç³»ç»Ÿ
function initRatingSystem() {
    // ä¸ºæ¯ä¸ªæ˜Ÿæ˜Ÿæ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.star-rating').forEach(ratingContainer => {
        const stage = ratingContainer.dataset.stage;
        const stars = ratingContainer.querySelectorAll('.star');
        
        stars.forEach((star, index) => {
            star.addEventListener('click', function() {
                const rating = index + 1;
                setStageRating(stage, rating);
            });
            
            star.addEventListener('mouseenter', function() {
                highlightStars(ratingContainer, index + 1);
            });
        });
        
        ratingContainer.addEventListener('mouseleave', function() {
            const currentRating = stageRatings[stage];
            highlightStars(ratingContainer, currentRating);
        });
    });
    
    // åŠ è½½å·²ä¿å­˜çš„è¯„åˆ†
    loadSavedRatings();
}

// è®¾ç½®é˜¶æ®µè¯„åˆ†
function setStageRating(stage, rating) {
    console.log(`[DEBUG] setStageRating called: stage=${stage}, rating=${rating}`);
    
    // ç¡®ä¿è¯„åˆ†åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ0-5ï¼‰
    rating = Math.max(0, Math.min(5, Math.round(rating)));
    stageRatings[stage] = rating;
    
    console.log(`[DEBUG] Updated stageRatings:`, stageRatings);
    
    const ratingContainer = document.querySelector(`.star-rating[data-stage="${stage}"]`);
    console.log(`[DEBUG] Found rating container for ${stage}:`, ratingContainer);
    
    if (ratingContainer) {
        highlightStars(ratingContainer, rating);
    }
    
    // æ›´æ–°è¯„åˆ†æ–‡æœ¬
    const ratingText = document.getElementById(`${stage}RatingText`);
    if (ratingText) {
        const ratingLabels = ['å¾ˆå·®', 'å¾ˆå·®', 'è¾ƒå·®', 'ä¸€èˆ¬', 'è‰¯å¥½', 'ä¼˜ç§€'];
        // 0åˆ†ä¹Ÿæ˜¯å·²è¯„åˆ†çŠ¶æ€ï¼Œæ˜¾ç¤ºä¸º"å¾ˆå·®"
        ratingText.textContent = ratingLabels[rating] || 'å¾ˆå·®';
        console.log(`[DEBUG] Updated rating text for ${stage}: ${ratingText.textContent}`);
    }
    
    // æ›´æ–°æ€»ä½“è¯„åˆ†
    updateOverallRating();
    
    // ä¸åœ¨è¿™é‡Œè‡ªåŠ¨ä¿å­˜ï¼Œé¿å…é¢‘ç¹è°ƒç”¨
    // saveRatings();
}

// é«˜äº®æ˜Ÿæ˜Ÿ
function highlightStars(container, count) {
    console.log(`[DEBUG] highlightStars called: count=${count}`);
    
    const stars = container.querySelectorAll('.star');
    console.log(`[DEBUG] Found ${stars.length} stars in container`);
    
    stars.forEach((star, index) => {
        if (index < count) {
            star.classList.add('active');
            console.log(`[DEBUG] Added 'active' class to star ${index + 1}`);
        } else {
            star.classList.remove('active');
            console.log(`[DEBUG] Removed 'active' class from star ${index + 1}`);
        }
    });
    
    // éªŒè¯æœ€ç»ˆçŠ¶æ€
    const activeStars = container.querySelectorAll('.star.active');
    console.log(`[DEBUG] Final active stars count: ${activeStars.length}`);
    
    // æ£€æŸ¥æ¯ä¸ªæ˜Ÿæ˜Ÿçš„æ ·å¼
    stars.forEach((star, index) => {
        const hasActive = star.classList.contains('active');
        const computedStyle = window.getComputedStyle(star);
        console.log(`[DEBUG] Star ${index + 1}: hasActive=${hasActive}, color=${computedStyle.color}`);
    });
}

// æ›´æ–°æ€»ä½“è¯„åˆ†
function updateOverallRating() {
    console.log('[DEBUG] updateOverallRating called');
    console.log('[DEBUG] Current stageRatings:', stageRatings);
    
    // æ–°çš„æƒé‡é…ç½®ï¼šæ„æ€10%ï¼Œæçº²0%ï¼Œæ­£æ–‡60%ï¼Œçˆ†ç‚¹30%
    const weights = {
        brainstorm: 0.10,  // æ„æ€ 10%
        outline: 0.00,     // æçº² 0%
        writing: 0.60,     // æ­£æ–‡ 60%
        highlight: 0.30    // çˆ†ç‚¹ 30%
    };
    
    let totalWeightedScore = 0;
    let totalWeight = 0;
    
    // è®¡ç®—åŠ æƒæ€»åˆ†
    Object.keys(stageRatings).forEach(stage => {
        const rating = stageRatings[stage];
        const weight = weights[stage] || 0;
        
        if (rating !== undefined && rating !== null) {
            // å°†5æ˜Ÿè¯„åˆ†è½¬æ¢ä¸º100åˆ†åˆ¶ï¼Œç„¶åä¹˜ä»¥æƒé‡
            const stageScore = (rating / 5) * 100;
            totalWeightedScore += stageScore * weight;
            totalWeight += weight;
            console.log(`[DEBUG] ${stage}: ${rating}æ˜Ÿ -> ${stageScore}åˆ† Ã— ${weight} = ${stageScore * weight}`);
        }
    });
    
    console.log('[DEBUG] Total weighted score:', totalWeightedScore);
    console.log('[DEBUG] Total weight:', totalWeight);
    
    // å¦‚æœæ²¡æœ‰ä»»ä½•è¯„åˆ†ï¼Œæ˜¾ç¤º0åˆ†
    if (totalWeight === 0) {
        console.log('[DEBUG] No valid ratings, setting score to 0');
        document.getElementById('overallScore').textContent = '0';
        return;
    }
    
    // è®¡ç®—æœ€ç»ˆåˆ†æ•°ï¼ˆå·²ç»æ˜¯åŠ æƒå¹³å‡ï¼‰
    const finalScore = Math.max(0, Math.min(100, Math.floor(totalWeightedScore)));
    console.log('[DEBUG] Final calculated score:', finalScore);
    
    document.getElementById('overallScore').textContent = finalScore;
    console.log('[DEBUG] Updated overall score display to:', finalScore);
}

// AIæ™ºèƒ½è¯„åˆ†
async function getAIRating() {
    const brainstormContent = document.getElementById('brainstormContent').value.trim();
    const outlineContent = document.getElementById('outlineContent').value.trim();
    const writingContent = document.getElementById('writingContent').value.trim();
    
    // è·å–AIè®¾ç½®
    const userSettings = Utils.getUserSettings();
    if (!userSettings.aiProvider || !userSettings.aiModel) {
        Utils.showAlert('è¯·å…ˆé…ç½®AIè®¾ç½®', 'warning');
        return;
    }
    
    // æ„å»ºAIè®¾ç½®å¯¹è±¡
    const parsedSettings = {
        provider: userSettings.aiProvider,
        model: userSettings.aiModel,
        base_url: userSettings.aiBaseUrl,
        api_key: localStorage.getItem('aiApiKey') || ''
    };
    
    showLoading('AIæ­£åœ¨æ™ºèƒ½è¯„åˆ†...');
    
    console.log('=== å¼€å§‹AIè¯„åˆ† ===');
    console.log('æ„æ€å†…å®¹é•¿åº¦:', brainstormContent.length);
    console.log('æçº²å†…å®¹é•¿åº¦:', outlineContent.length);
    console.log('æ­£æ–‡å†…å®¹é•¿åº¦:', writingContent.length);
    
    try {
        // ä½¿ç”¨æ–°çš„è¯„åˆ†API
        const response = await fetch('/api/ai/score_article', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                article_data: {
                    brainstorm: brainstormContent,
                    outline: outlineContent,
                    writing: writingContent,
                    highlight: brainstormContent + '\n' + outlineContent + '\n' + writingContent  // çˆ†ç‚¹åŸºäºå…¨æ–‡å†…å®¹è¯„ä¼°
                },
                ai_provider: parsedSettings.provider,
                ai_model: parsedSettings.model,
                ai_api_key: parsedSettings.api_key,
                ai_base_url: parsedSettings.base_url
            })
        });
        
        console.log('AIè¯„åˆ†å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('AIè¯„åˆ†ç»“æœ:', result);
        
        if (result.success && result.data && result.data.scores) {
            const scores = result.data.scores;
            const stageReasons = result.data.stage_reasons || {};
            console.log('AIè¿”å›çš„åˆ†æ•°:', scores);
            console.log('AIè¿”å›çš„è¯„ä»·:', stageReasons);
            
            // å°†100åˆ†åˆ¶è½¬æ¢ä¸º0-5æ˜Ÿçº§è¯„åˆ†
            if (scores.brainstorm !== undefined) {
                const brainstormRating = Math.max(0, Math.min(5, Math.round((scores.brainstorm / 100) * 5)));
                console.log('æ„æ€å†…å®¹æœ‰å†…å®¹ï¼ŒAIè¯„åˆ†:', brainstormRating);
                setStageRating('brainstorm', brainstormRating);
            }
            if (scores.outline !== undefined) {
                const outlineRating = Math.max(0, Math.min(5, Math.round((scores.outline / 100) * 5)));
                console.log('æçº²å†…å®¹æœ‰å†…å®¹ï¼ŒAIè¯„åˆ†:', outlineRating);
                setStageRating('outline', outlineRating);
            }
            if (scores.writing !== undefined) {
                const writingRating = Math.max(0, Math.min(5, Math.round((scores.writing / 100) * 5)));
                console.log('æ­£æ–‡å†…å®¹æœ‰å†…å®¹ï¼ŒAIè¯„åˆ†:', writingRating);
                setStageRating('writing', writingRating);
            }
            if (scores.highlight !== undefined) {
                const highlightRating = Math.max(0, Math.min(5, Math.round((scores.highlight / 100) * 5)));
                console.log('çˆ†ç‚¹å†…å®¹è¯„åˆ†:', highlightRating);
                setStageRating('highlight', highlightRating);
            }
            
            // æ˜¾ç¤ºæ­£æ–‡å’Œçˆ†ç‚¹çš„è¯„ä»·åœ¨å³ä¾§AIå»ºè®®åŒºåŸŸ
            displayScoringFeedback(scores, stageReasons);
            
            // è‡ªåŠ¨ä¿å­˜è¯„åˆ†
            await saveRatings();
            Utils.showAlert('AIè¯„åˆ†å®Œæˆå¹¶å·²è‡ªåŠ¨ä¿å­˜ï¼', 'success');
        } else {
            // è¯„åˆ†å¤±è´¥æ—¶ç»™å‡ºåŸºç¡€è¯„åˆ†ï¼Œæ ¹æ®å†…å®¹é•¿åº¦ç»™åˆ†
            setStageRating('brainstorm', brainstormContent.length > 0 ? 1 : 0);
            setStageRating('outline', outlineContent.length > 0 ? 1 : 0);
            setStageRating('writing', writingContent.length > 0 ? 1 : 0);
            setStageRating('highlight', (brainstormContent + outlineContent + writingContent).length > 0 ? 1 : 0);
            
            // è‡ªåŠ¨ä¿å­˜è¯„åˆ†
            await saveRatings();
            Utils.showAlert('AIè¯„åˆ†å¤±è´¥ï¼Œå·²ç»™å‡ºåŸºç¡€è¯„åˆ†å¹¶ä¿å­˜', 'warning');
        }
    } catch (error) {
        console.error('AIè¯„åˆ†é”™è¯¯:', error);
        
        // å³ä½¿å‡ºç°å¼‚å¸¸ä¹Ÿç»™å‡ºåŸºç¡€è¯„åˆ†ï¼Œç©ºå†…å®¹ç»™0åˆ†ï¼Œæœ‰å†…å®¹ç»™1åˆ†
        setStageRating('brainstorm', brainstormContent.length > 0 ? 1 : 0);
        setStageRating('outline', outlineContent.length > 0 ? 1 : 0);
        setStageRating('writing', writingContent.length > 0 ? 1 : 0);
        setStageRating('highlight', (brainstormContent + outlineContent + writingContent).length > 0 ? 1 : 0);
        
        // è‡ªåŠ¨ä¿å­˜è¯„åˆ†
        try {
            await saveRatings();
            Utils.showAlert('AIè¯„åˆ†å¼‚å¸¸ï¼Œå·²ç»™å‡ºæœ€ä½è¯„åˆ†å¹¶ä¿å­˜', 'warning');
        } catch (saveError) {
            Utils.showAlert('AIè¯„åˆ†å¤±è´¥ï¼Œä¿å­˜è¯„åˆ†ä¹Ÿå¤±è´¥ï¼š' + error.message, 'error');
        }
    } finally {
        hideLoading();
    }
}

// æ˜¾ç¤ºè¯„åˆ†åé¦ˆ
function displayScoringFeedback(scores, stageReasons) {
    const aiFeedbackDiv = document.getElementById('aiFeedback');
    if (!aiFeedbackDiv) return;
    
    let feedbackHtml = '<div class="ai-scoring-feedback">';
    feedbackHtml += '<h6 class="text-primary mb-3"><i class="fas fa-chart-line me-2"></i>AIè¯„åˆ†è¯¦æƒ…</h6>';
    
    // æ˜¾ç¤ºæ­£æ–‡è¯„ä»·
    if (scores.writing !== undefined && stageReasons.writing) {
        feedbackHtml += '<div class="feedback-section mb-3">';
        feedbackHtml += '<div class="d-flex align-items-center mb-2">';
        feedbackHtml += '<span class="badge bg-primary me-2">æ­£æ–‡</span>';
        feedbackHtml += `<span class="fw-bold">${scores.writing}åˆ†</span>`;
        feedbackHtml += '</div>';
        feedbackHtml += `<div class="feedback-content text-muted small">${stageReasons.writing}</div>`;
        feedbackHtml += '</div>';
    }
    
    // æ˜¾ç¤ºçˆ†ç‚¹è¯„ä»·
    if (scores.highlight !== undefined && stageReasons.highlight) {
        feedbackHtml += '<div class="feedback-section mb-3">';
        feedbackHtml += '<div class="d-flex align-items-center mb-2">';
        feedbackHtml += '<span class="badge bg-warning me-2">çˆ†ç‚¹</span>';
        feedbackHtml += `<span class="fw-bold">${scores.highlight}åˆ†</span>`;
        feedbackHtml += '</div>';
        feedbackHtml += `<div class="feedback-content text-muted small">${stageReasons.highlight}</div>`;
        feedbackHtml += '</div>';
    }
    
    // å¦‚æœæœ‰æ€»åˆ†ï¼Œæ˜¾ç¤ºæ€»åˆ†
    if (scores.writing !== undefined || scores.highlight !== undefined) {
        // ä»DOMä¸­è·å–å½“å‰æ˜¾ç¤ºçš„æ€»åˆ†
        const overallScoreElement = document.getElementById('overallScore');
        const totalScore = overallScoreElement ? overallScoreElement.textContent : '0';
        feedbackHtml += '<div class="feedback-section border-top pt-2">';
        feedbackHtml += '<div class="d-flex align-items-center justify-content-between">';
        feedbackHtml += '<span class="fw-bold">æ€»åˆ†ï¼š</span>';
        feedbackHtml += `<span class="fw-bold text-primary">${totalScore}åˆ†</span>`;
        feedbackHtml += '</div>';
        feedbackHtml += '</div>';
    }
    
    feedbackHtml += '</div>';
    
    aiFeedbackDiv.innerHTML = feedbackHtml;
}

// ä¿å­˜è¯„åˆ†
async function saveRatings() {
    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stage_ratings: stageRatings
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('è¯„åˆ†å·²è‡ªåŠ¨ä¿å­˜');
        }
    } catch (error) {
        console.error('ä¿å­˜è¯„åˆ†å¤±è´¥:', error);
    }
}

// åŠ è½½å·²ä¿å­˜çš„è¯„åˆ†
async function loadSavedRatings() {
    console.log(`[DEBUG] loadSavedRatings called for project ${projectId}`);
    
    try {
        const response = await fetch(`/api/projects/${projectId}`);
        console.log(`[DEBUG] API response status: ${response.status}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log(`[DEBUG] API result:`, result);
            
            if (result.success && result.data) {
                const project = result.data;
                console.log(`[DEBUG] Project data:`, project);
                console.log(`[DEBUG] Project scores field:`, project.scores);
                console.log(`[DEBUG] Project final_score:`, project.final_score);
                
                // ä»é¡¹ç›®çš„scoreså­—æ®µä¸­è§£æè¯„åˆ†
                let savedRatings = {
                    brainstorm: 0,
                    outline: 0, 
                    writing: 0,
                    highlight: 0
                };
                
                if (project.scores) {
                    try {
                        const scores = typeof project.scores === 'string' ? JSON.parse(project.scores) : project.scores;
                        console.log(`[DEBUG] Parsed scores:`, scores);
                        
                        savedRatings = {
                            brainstorm: scores.brainstorm || 0,
                            outline: scores.outline || 0,
                            writing: scores.writing || 0,
                            highlight: scores.highlight || 0
                        };
                        console.log(`[DEBUG] Mapped savedRatings:`, savedRatings);
                    } catch (e) {
                        console.warn('è§£æè¯„åˆ†æ•°æ®å¤±è´¥:', e);
                    }
                }
                
                // æ›´æ–°å…¨å±€è¯„åˆ†å¯¹è±¡
                stageRatings = savedRatings;
                console.log(`[DEBUG] Updated global stageRatings:`, stageRatings);
                
                // è®¾ç½®è¯„åˆ†å¹¶æ›´æ–°æ˜¾ç¤º
                Object.keys(savedRatings).forEach(stage => {
                    console.log(`[DEBUG] Setting rating for stage ${stage}: ${savedRatings[stage]}`);
                    setStageRating(stage, savedRatings[stage]);
                });
            }
        }
    } catch (error) {
        console.error('åŠ è½½è¯„åˆ†å¤±è´¥:', error);
    }
}

// æ›´æ–°å­—æ•°ç»Ÿè®¡å‡½æ•° - æ”¯æŒå¤šä¸ªé˜¶æ®µ
function updateWordCountForStage(stage) {
    const textarea = document.getElementById(stage + 'Content');
    const content = textarea.value;
    const wordCount = content.replace(/\s/g, '').length;
    
    // æ›´æ–°å¯¹åº”é˜¶æ®µçš„å­—æ•°ç»Ÿè®¡
    const stageIndex = {'brainstorm': '', 'outline': '2', 'writing': '3'}[stage] || '';
    const countElement = document.getElementById(`currentWordCount${stageIndex}`);
    if (countElement) {
        countElement.textContent = wordCount;
    }
    
    // æ›´æ–°é¡¶éƒ¨æ€»å­—æ•°
    const totalWordCount = 
        document.getElementById('brainstormContent').value.replace(/\s/g, '').length +
        document.getElementById('outlineContent').value.replace(/\s/g, '').length +
        document.getElementById('writingContent').value.replace(/\s/g, '').length;
    
    document.getElementById('wordCount').textContent = totalWordCount;
    
    // æ›´æ–°å¯¹åº”é˜¶æ®µçš„è¿›åº¦æ¡
    const progressElement = document.getElementById(`progressBar${stageIndex}`);
    if (progressElement) {
        const progress = Math.min((wordCount / 1000) * 100, 100);
        progressElement.style.width = progress + '%';
    }
}

// é‡å†™å­—æ•°ç»Ÿè®¡å‡½æ•°
function updateWordCount() {
    updateWordCountForStage(currentStage);
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DEBUG] DOMContentLoaded event fired');
    console.log('[DEBUG] Initial stageRatings:', stageRatings);
    console.log('[DEBUG] Project ID:', projectId);
    
    updateWordCount();
    initRatingSystem();
    
    console.log('[DEBUG] About to call loadSavedRatings');
    loadSavedRatings();
    
    // ç¡®ä¿æ˜Ÿæ˜Ÿæ˜¾ç¤ºæ­£ç¡®
    setTimeout(() => {
        console.log('[DEBUG] Timeout callback - checking stageRatings:', stageRatings);
        Object.keys(stageRatings).forEach(stage => {
            console.log(`[DEBUG] Checking stage ${stage} with rating ${stageRatings[stage]}`);
            if (stageRatings[stage] > 0) {
                console.log(`[DEBUG] Re-setting rating for stage ${stage}`);
                setStageRating(stage, stageRatings[stage]);
            }
        });
    }, 100);
    
    // ä¸ºæ‰€æœ‰æ–‡æœ¬æ¡†ç»‘å®šå­—æ•°ç»Ÿè®¡äº‹ä»¶
    ['brainstorm', 'outline', 'writing'].forEach(stage => {
        const textarea = document.getElementById(stage + 'Content');
        if (textarea) {
            textarea.addEventListener('input', function() {
                updateWordCountForStage(stage);
                
                // è‡ªåŠ¨ä¿å­˜ï¼ˆé™é»˜ï¼‰
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => saveProject(false), 5000);
            });
        }
    });
    
    // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆé™é»˜ï¼‰
    setInterval(() => saveProject(false), 60000); // æ¯åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
});

// é¡µé¢ç¦»å¼€å‰ä¿å­˜ï¼ˆé™é»˜ï¼‰
window.addEventListener('beforeunload', function() {
    saveProject(false);
});

// æ’å…¥ç»­å†™å†…å®¹åˆ°å½“å‰æ–‡æœ¬æ¡†
function insertContinuation(text) {
    const textarea = document.getElementById(currentStage + 'Content');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ç»­å†™å†…å®¹
    const newText = textBefore + text + textAfter;
    textarea.value = newText;
    
    // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°æ’å…¥å†…å®¹çš„æœ«å°¾
    const newCursorPos = cursorPos + text.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
    
    // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥æ›´æ–°å­—æ•°ç»Ÿè®¡
    textarea.dispatchEvent(new Event('input'));
    
    Utils.showAlert('ç»­å†™å†…å®¹å·²æ’å…¥', 'success');
}
</script>
{% endblock %}